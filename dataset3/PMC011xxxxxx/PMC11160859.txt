
==== Front
ArXiv
ArXiv
arxiv
ArXiv
2331-8422
Cornell University

arXiv:2405.17032v1
2405.17032
1
preprint
Article
EXACT PHYLODYNAMIC LIKELIHOOD VIA STRUCTURED MARKOV GENEALOGY PROCESSES
KING AARON A. Department of Ecology & Evolutionary Biology, Center for the Study of Complex Systems, and Department of Mathematics, University of Michigan, Ann Arbor, MI 48109 USA and Santa Fe Institute, 1399 Hyde Park Road, Santa Fe, NM 87501 USA

LIN QIANYING Theoretical Biology and Biophysics, Los Alamos National Laboratory, Los Alamos, NM 87545 USA

IONIDES EDWARD L. Department of Statistics, University of Michigan, Ann Arbor, MI 48109 USA

A. A. King, kingaa@umich.edu, https://kinglab.eeb.lsa.umich.edu/
27 5 2024
arXiv:2405.17032v1https://creativecommons.org/licenses/by/4.0/ This work is licensed under a Creative Commons Attribution 4.0 International License, which allows reusers to distribute, remix, adapt, and build upon the material in any medium or format, so long as attribution is given to the creator. The license allows for commercial use.
nihpp-2405.17032v1.pdf
We consider genealogies arising from a Markov population process in which individuals are categorized into a discrete collection of compartments, with the requirement that individuals within the same compartment are statistically exchangeable. When equipped with a sampling process, each such population process induces a time-evolving tree-valued process defined as the genealogy of all sampled individuals. We provide a construction of this genealogy process and derive exact expressions for the likelihood of an observed genealogy in terms of filter equations. These filter equations can be numerically solved using standard Monte Carlo integration methods. Thus, we obtain statistically efficient likelihood-based inference for essentially arbitrary compartment models based on an observed genealogy of individuals sampled from the population.
==== Body
pmc1. Introduction.

When the genome of an infectious agent accumulates mutations on timescales similar to those of transmission and infection progression, the resulting pattern of differences among genomes contains information on the history of the pathogen’s passage through individual hosts and the host population. As Grenfell et al. (2004) observed, one can extract this information to gain insight into the structure and dynamics of the host-pathogen system. In particular, one can formalize mathematical models of transmission, estimate their parameters, and compare their ability to explain data, following standard statistical paradigms. This is known as phylodynamic inference. Alizon (2024) gives a good review of the history of the subject.

The most common approach to phylodynamic inference rests upon a mathematical linkage between the tree-like genealogy or phylogeny that expresses the relationships of shared ancestry among sampled genomes and a model of the dynamics of the transmission system. Various linkages are possible, but because it is maximally efficient (i.e., loses the least information), it is desirable to be able to compute the likelihood function for models of interest. This is simply the probability density of a given genealogy conditional on a given model, viewed as a function of the parameters of that model. In particular, if S is a set of genome sequences, Φ a genealogical tree relating these sequences, E a model of sequence evolution, and D a dynamic transmission model, then the likelihood is ℒD,E=fSD,E=∫fSΦ,EfΦDdΦ,

where the integral is taken over all possible genealogies and we somewhat loosely use the symbol f for the various distinct probability densities, the nature of each of which is clear from its arguments. In this expression, f(S∣Φ,E) is typically the Felsenstein (2004) phylogenetic likelihood. The function f(Φ∣D), which links the phylogeny to the dynamic model, may be termed the phylodynamic likelihood. In the Bayesian context, this same function is sometimes referred to as a tree prior (Möller et al., 2018; Volz & Siveroni, 2018). The computation of this function has remained out of reach, except in several special cases. This paper presents theory that enables its computation for a very broad range of dynamic models.

Existing approaches to the phylodynamic likelihood have been based on one of two mathematical idealizations. The first is the Kingman (1982a) coalescent, by which likelihood of a given genealogy is computed using a reverse-time argument. This computation provides the exact likelihood for a genealogy resulting from a particular, constant population-size, dynamic model (the Moran model, e.g., Moran, 1958; Kingman, 1982b; Möhle, 2000). Extensions of this approach develop approximate likelihoods for the case when the population size varies as a function of time (Griffiths & Tavaré, 1994; Drummond et al., 2005) or according to an SIR process (Volz et al., 2009; Rasmussen et al., 2011), as long as the population size is large and the sample-fraction remains negligible. The second idealization is the linear birth-death process, for which exact expressions for the likelihood are available (Stadler, 2010). Linearity in this context amounts to the assumption that distinct lineages do not interact: it is the resulting self-similarity of genealogies that renders the likelihood analytically tractable. Extensions of this approach develop approximations via linearization of nonlinear processes or restriction to scenarios in which population growth is nearly linear (e.g., MacPherson et al., 2021). Although the tractability of these approaches makes them attractive, concern naturally arises as to validity of the approximations in specific cases, the biases introduced by them, and the amount of information in data left unutilized by these approximate methods. For this reason, there is interest in improved phylodynamic inference techniques.

What would an ideal phylodynamic inference method look like? First, it would afford exact computation of the phylodynamic likelihood, so that comparisons among parameterizations and models could be made on a sound basis. Second, because nonlinearity, nonstationarity, noise, and measurement error are prominent and ubiquitous in epidemiology, it would accommodate nonlinear, time-inhomogeneous, stochastic transmission models. Third, because many of the most scientifically important uncertainties concern heterogeneities in transmission rates and the susceptibility, behavior, age, and location of hosts, it would accommodate host populations structured by these factors. While some structuring factors (e.g., age, spatial location) are most naturally expressed in terms of continuous variables, discretely structured models have repeatedly proved their value in epidemiology. In particular, compartmental models are extremely flexible and have often been used as approximations when continuous structure leads to uncomfortably high model dimension. Finally, because there is typically uncertainty not only in the parameters, but also in the structure, of a host-pathogen system, an improved phylodynamic inference methodology would place minimal restrictions on the form of the models that it can accommodate. This paper demonstrates how these desiderata can be achieved—at least for models with discrete structure—including arbitrary nonlinear compartmental models with a countable number of compartments.

To connect a model at the level of a population with genealogies based on samples taken from individual hosts, it is necessary to make assumptions about the individuals in the population. The simplest such assumption is that the individuals that are identical with respect to the population dynamics are indeed statistically identical. That is, that they are exchangeable. In a compartmental model, this is tantamount to the assumption that the residence times of the individuals within each compartment are identically distributed, though not independent. Although exchangeability is indeed an additional assumption, it is so natural that it is frequently unrecognized as such, and one often reads statements to the effect that exchangeability of individuals is a consequence of the Markovian assumption. Nonetheless, since it adds minimal additional structure, it is the natural assumption, and the one we will make in this paper.

In the following, we take as our starting point a transmission model in the form of a discretely structured, Markov process. We show how such a process uniquely induces each of several stochastic processes in the space of genealogies. We go on to derive expressions for the exact likelihoods of these genealogies.

Code sufficient for the reproduction of all the results presented in this paper are freely available for download at https://github.com/kingaa/structured-genealogy-process-paper. An archival version of these will be stored on Zotero upon publication of this paper. The open-source R package phylopomp (https://github.com/kingaa/phylopomp) implements the simulation and likelihood-computation algorithms employed here.

2. Mathematical preliminaries.

2.1. Notation.

Throughout the paper, we will adopt the convention that a bold-face symbol (e.g., X), denotes a random element. We will be concerned with a variety of stochastic processes, in both discrete and continuous time. In both cases, we will use a subscript to indicate the time parameter: e.g., Xt or Gk, where t takes values in the non-negative reals R+ and k in the non-negative integers Z+. In the case of continuous-time processes, we will assume that sample paths are càdlàg i.e., right-continuous with left limits. We will frequently need to refer to the left-limit of such a process. Accordingly, if Φt is a càdlàg random process, we define Φ~t:=lims↑t Φs,t>0,Φ0,t=0.

Note that Φ~t is thus left-continuous with right limits.

If Φt, t∈R+ is a pure jump process, knowledge of its sample path is equivalent to knowledge of the number, Kt, of jumps it has taken as of time t, the jump times Tˆk, and the embedded chain Φˆk:=ΦTˆk, k=0,…,Kt. In particular, if we adopt the convention that Tˆ0=0 and TˆKt+1=t, then Φt=Φˆk for t∈Tˆk,Tˆk+1,k=0,…,Kt.

2.2. Population process.

We are motivated by the desire for exact phylodynamic inference methods for as wide a class of epidemiological models as possible. In particular, we would like to be able to formulate and parameterize an arbitrary compartmental model and to quantify its ability to explain data using likelihood. Fig. 1 depicts a few such models in order to give a sense of the kinds of complexities that can arise. Of course, with the ability to entertain models with countably many compartments, much greater complexity is possible. In particular, one can model not only complex infection progression, but also strain structure, behavioral structure, age structure, and spatial structure using compartmental models. As is well known, one can discretize continuous structure-variables and employ the linear chain trick to accommodate non-exponential residence times. While the utility of these approximations will vary, a very wide range of model assumptions lie within the scope of the theory presented here.

We will assume that our population process is a time-inhomogeneous Markov jump process, Xt, t∈R+, taking values in some space X. In earlier work (King et al., 2022), we limited ourselves to the case X=Zd, but here we assume only that X is a complete metric measure space with a countable dense subset. The population process is completely specified by its initial-state density, p0, and its transition rates α. In particular, we suppose that (1) ProbX0∈ℰ=∫ℰ p0(x)dx

for all measurable sets ℰ⊆X. For any t∈R+,x,x′∈X, we think of the quantity αt,x,x′ as the instantaneous hazard of a jump from x to x′. More precisely, the transition rates have the following properties: αt,x,x′⩾0,∫X αt,x,x′dx′<∞,

for all t∈R+ and x,x′∈X and that, as a function of time, α is continuous almost everywhere. Henceforth, we understand that integrals are taken over all of X unless otherwise specified. Let Kt be the number of jumps that X has taken by time t. We assume that Kt is a simple counting process so that ProbKt+Δ=n+1∣Kt=n=Δ∫αt,x,x′dx′+o(Δ),

ProbKt+Δ>n+1∣Kt=n=o(Δ),

ProbXt+Δ∈ℰ∣Xt=x,Kt+Δ-Kt=1=∫ℰ  αt,x,x′dx′∫αt,x,x′dx′+o(Δ).

We further assume that αt,x,x′ is càdlàg as a function of time for all x,x′∈X and that the number of jumps that occur in a finite time-interval is finite, i.e., ProbKt<∞=1 for all t.

2.3. Kolmogorov forward equation.

The above may be compactly summarized by stating that if v(t,x) satisfies the Kolmogorov forward equation (KFE), (2) ∂v∂tt,x=∫vt,x′αt,x′,xdx′-∫vt,xαt,x,x′dx′,

and if, moreover, v(0,x)=p0(x), then ∫ℰ vt,xdx=ProbXt∈ℰ for every measurable ℰ⊆X. Eq. 2 is sometimes called the master equation for Xt.

2.4. Inclusion of jumps at deterministic times.

For modeling purposes, it is sometimes desirable to insist that certain events occur at known times. For example, if samples are collected at specific times in such a way that the timing itself conveys no information about the process, one might wish to condition on the sampling time. We can expand the class of population models to allow for this as follows. Suppose that S=s1,s2,…,⊂Z+ is a sequence of event times. Let us postulate that, at each of these times, an event occurs at which Xt jumps according to a given probability kernel π. In particular, for any state x∈X and measurable ℰ⊂X, πsi,x,ℰ is the probability that the jump at time si is to ℰ, conditional on the state just before the jump being x. With this notation, the KFE for the process becomes (3) ∂v∂tt,x=∫vt,x′αt,x′,xdx′-∫vt,xαt,x,x′dx′,t∉S,

(4) vt,xdx=∫v~t,x′πt,x′,dxdx′,t∈S.

Note that the Eq. 3 is identical to Eq. 2; we call this the regular part of the KFE. We refer to Eq. 4 as the singular part of the KFE.

As a matter of notation, one can represent Eqs. 3 and 4 as a single equation in the form of Eq. 2. In particular, if in Eq. 2 we make the substitution αt,x,x′↦αt,x,x′+∑s∈S δt,sdπdx′t,x,x′,

we obtain an equation which we can view as shorthand for Eqs. 3 and 4. Here, δ(t,s) is a Dirac delta function and dπ/dx′ denotes the density (i.e., Radon-Nikodym derivative) of π with respect to the measure on X.

2.5. Jump marks.

It will be useful to divide the jumps of the population process Xt into distinct categories, which differ with respect to the changes they induce in a genealogy. For this purpose, we let U be a countable set of jump marks such that αt,x,x′=∑u∈U αut,x,x′.

Fig. 2 shows an example for which U has five elements. In the following, sums over u are to be taken over the whole of U unless otherwise indicated.

Let us define the jump mark process, Ut, to be the mark of the latest jump as of time t. As usual, we take the sample paths of Ut to be càdlàg. Observe that, though Xt and Xt,Ut are Markov processes, Ut is not.

2.6. Demes and deme occupancy.

Our first goal in this paper is to show how a given population process induces a unique stochastic process on the space of genealogies. At each time, this genealogy will represent the relationships of shared ancestry among a population of lineages extant at that time. To accommodate the structure of the population, this population of lineages will itself be subdivided into discrete categories. In particular, we suppose that there are a countable set of subpopulations, within each of which individual lineages are exchangeable. We call these subpopulations demes, and use the symbol D to denote an index set for them. Fig. 1 illustrates this concept in the context of several compartmental models.

We define the deme occupancy function n:D×X→Z+ so that for i∈D, x∈X, ni(x) is the number of lineages in deme i when the population is in state x.

2.7. Examples.

The class of population models to which the theory presented here applies is very broad indeed. In particular, it encompasses the entire class of compartmental models with time-dependent flow rates. Here, to give a sense of this breadth, we briefly describe a few models of interest. Appendix B works out the theory for each of these examples.

SIRS model.

King et al. (2022) worked out formulas for the exact likelihood of a genealogy induced by an SIRS model. The theory developed in this paper applies, but since there is only one deme in this model, this is a simple case.

SEIRS model.

A simple, yet interesting, model with more than one deme is the SEIRS model (Fig. 1A). The state space is Z+4, with the state x=(S,E,I,R) defined by the numbers of hosts in each of the four compartments. It has two demes: D={E,I}. The deme occupancy function in this case is n(x)=(E,I). Note that the terms associated with sampling cancel each other in the KFE, since, in this model, sampling has no effect on the state.

Two-strain competition model.

A simple model for the competition of two strains for susceptible hosts is depicted in Fig. 1B. In this model, the state vector consists of seven numbers: x=S,E1,E2,I1,I2,R1,R2. There are four demes D=E1,E2,I1,I2 and the occupancy function is n(x)=E1,E2,I1,I2.

Superspreading model.

Fig. 1D depicts a model of superspreading. There are three demes D=E,IL,IH.

Linear birth-death model.

The linear birth-death process, a mainstay of existing phylodynamic methods, is a special case of the theory presented here. For this process, we have X=Z+ and there is a single deme. Xt represents the size of a population and nXt=Xt.

Moran model and the Kingman coalescent.

The Kingman (1982a) coalescent is another workhorse in existing phylodynamic approaches. It is the ancestral process for the Moran model, in which a fixed population of n lineages experiences events at times distributed according to a rate-μ Poisson process. At each such event, an individual lineage selected uniformly at random dies and is replaced by the offspring of a second randomly selected lineage.

2.8. History.

Consider the Markov process Xt,Ut. We define its history process, Ht, to be the restriction of the random function s↦Xs,Us to the interval [0,t]. Note that Ht is itself trivially a Markov process, since it contains its own history.

Alternatively, one can think of Ht as consisting of the sequence Tˆk,Xˆk,Uˆkk=0Kt. In particular, conditional on Ht, both Xt and Ut are deterministic, as are Kt, the embedded chains, Xˆk, Uˆk, and the point process of event times Tˆk. The probability measure on the space of histories can be expressed in terms of these: (5) ProbdHt=p0(X^0)dX^0∏k=1KtαU^kT^k,X^k−1,X^kdX^kdT^kexp−∑k=0Kt∫T^kT^k+1∑u∫αu(t′,X^k,x′)dx′dt′,

where again, by convention, Tˆ0=0 and TˆKt+1=t.

If H is such a history, we define t(H) to be the right endpoint of its domain and use the notation evH≔Tˆ1,…,TˆKt⊂[0,t(H)] to denote the set of its jump times.

2.9. Genealogies.

A genealogy, G, encapsulates the relationships of shared ancestry among a set of lineages that are extant at some time t(G)∈R+ and perhaps a set of samples collected at earlier times (Fig. 3). A genealogy has a tree- or forest-like structure, with four distinct kinds of nodes: (i) tip nodes, which represent labeled extant lineages; (ii) internal nodes, which represent events at which lineages diverged and/or moved from one deme to another; (iii) sample nodes, which represent labeled samples; and (iv) root nodes, at the base of each tree. Each node a is associated with a specific time, t(a). In particular, if a is a tip node in G, then t(a)=t(G); if a is a sample node, then t(a)⩽t(G) is the time at which the sample was taken. Moreover, if node a is ancestral to node a′, then t(a)⩽ta′ and ta′-t(a) is the distance between a and a′ along the genealogy. Without loss of generality we assume that t(a)=0 for all root nodes a. We let ev(G) denote the set of all internal and sample node-times of the genealogy G; we refer to these as genealogical event times.

Importantly, a genealogy informs us not only about the shared ancestry of any pair of lineages, but also about where in the set of demes any given lineage was at all times. Accordingly, we can visualize a genealogy as a tree, the nodes and edges of which are painted with a distinct color for each deme (Fig. 3). Note that a genealogy will in general have branch-point nodes, i.e., internal nodes with more than one descendant, but may also have internal nodes with only one descendant. We refer to such nodes as inline nodes. These occur whenever the color changes along a branch, but can also occur without a color-change.

Formally, we define a genealogy, G, to be a triple, (T,Z,Y), where T=t(G)∈R+ is the genealogy time, Z specifies the genealogy’s tree structure, and Y gives the coloring. In particular, let L be a countable set of labels and let partit (L) be the set of all collections of finite, mutually-disjoint subsets of L. That is, an element z∈partit(L) is a partition of the finite set ⋃z⊆L. Partition fineness defines a partial order on partit (L). Specifically, for z,z′∈partit(L), we say z≼z′ if and only if for every b′∈z′ there is b∈z such that b⊇b′. The tree structure of G is defined by a càdlàg map Z:[0,T]→partit(L) that is monotone in the sense that t1⩽t2 implies Zt1≼Zt2. An element b∈Zt is a set of labels; it represents the branch of the tree that bears the corresponding lineages. We use the notation ev(Z) to denote the set of times at which Z is discontinuous. Note that ev(Z) includes the times of all tip, sample, and branch-point nodes, but excludes inline and root nodes. Therefore, ev(Z)⊆ev(G).

The third element of G specifies the coloring of branches and locations of tip, sample, and internal nodes (including inline nodes). Mathematically, if G=(T,Z,Y), then Y is a càdlàg function that maps each point on the genealogy to a deme and a non-negative integer. In particular, if t∈[0,T] and a is the label of any tip or sample node, Yt(a)=Ytd(a),Ytm(a)∈D×Z+, where Ytd(a) is the deme in which the lineage of a is located at time t and Ytm(a) is the number of internal or sample nodes encountered along the lineage of a in going from time 0 to time t. In particular, Ytm(a) is a simple counting process, with Y0m(a)=0 for all a. Since a,a′∈b∈Zt implies Yt(a)=Yta′, one can equally well think of Yt as a map Zt→D×Z+. Given a tree Z, we let Y(Z) denote the set of colorings Y that are compatible with Z. We moreover define YtZ≔Yt∣Y∈Y(Z). Formally speaking, Y(Z) is a fiber bundle over Z, each Yt(Z) being a fiber.

It will sometimes be convenient to make use of notation whereby a genealogy G=t(G),GZ,GY.

2.10. Binomial ratio.

For n,r,ℓ,s∈Z+D, define the binomial ratio nℓrs:=∏i∈Dni−ℓiri−si∏i∈Dniri,if∀ini⩾ℓi,ri⩾si⩾0,0,otherwise.

Observe that nℓrs∈[0,1]. Moreover, in consequence of the Chu-Vandermonde identity, we have ∑s∈Z+D nℓrsℓs=1,

whenever ni⩾ℓi,ri⩾0 for all i.

3. The induced genealogy process.

3.1. Event types.

We now show how a given population process naturally induces a process in the space of genealogies. Specifically, at each jump in the population process, a corresponding change occurs in the genealogy, according to whether lineages branch, die, move between demes, or are sampled. For this purpose, there are five distinct pure types of events:

Birth-type events result in the branching of one or more new lineages, each from some existing lineage. Examples of birth-type events include transmission events, speciations, and actual births. Importantly, we assume that all new lineages arising from a birth event share the same parent and that at most one birth event occurs at a time, almost surely.

Death-type events result in the extinction of one or more lineages. Examples include recovery from infection, death of a host, and species extinctions. We allow for the possibility that multiple lineages die simultaneously.

Migration-type events result in the movement of a lineage from one deme to another. Spatial movements, changes in host age or behavior, and progression of an infection can all be represented as migration-type events. We permit multiple lineages to move simultaneously.

Sample-type events result in the collection of a sample from a lineage. We allow for the possibility that multiple samples are collected simultaneously, though we require that, in this case, each extant lineage is sampled at most once.

Neutral-type events result in no change to any of the lineages.

Fig. 2 depicts an example with jumps of all five pure types. It is not necessary that an event be of a pure type; compound events partake of more than one type. For example, a sample/death-type event, in which a lineage is simultaneously sampled and removed, has been employed (Leventhal et al., 2014), as have birth/death events in which one lineage reproduces at the same moment that another dies (e.g., the Moran (1958) process). The theory presented here places few restrictions on the complexity of the events that can occur by combining events of the various pure types.

3.2. Genealogy process.

We now show how a given population process induces a stochastic process, Gt, on the space of genealogies. In the case of unstructured population processes (i.e., those having a single deme), King et al. (2022) gave a related construction that is equivalent to the one presented here.

At each jump in the population process, a change is made to the genealogy, according to the mark, u, of the jump (Fig. 4). In particular:

If u is of birth-type (Fig. 4A), it results in the creation of one new internal node, call it b. A tip node, a, of the appropriate deme is chosen with uniform probability from among those present and b is inserted so that its ancestor is that of a, while a takes b as its ancestor. One new tip node, of the appropriate deme, is created for each of the children, all of which take b as their immediate ancestor.

If u is of death-type (Fig. 4B), one or more tip nodes of the appropriate demes are selected with uniform probability from among those present. These are deleted. Next, internal nodes without children are recursively removed. Sample nodes are never removed.

At a migration-type event (Fig. 4C), the appropriate number of migrating lineages are selected at random with uniform probability, from among those present in the appropriate demes. For each selected lineage, one new branch node is inserted between the selected tip node and its ancestor. The color of the descendant branch changes accordingly.

At a sample-type event (Fig. 4D), the appropriate number of sampled lineages are selected at random from among the tip nodes, with uniform probability according to deme. One new sample node is introduced for each selected lineage: each is inserted between a selected tip nodes and its ancestor.

At a neutral-type event (Fig. 4E), no change is made to the genealogy.

Finally, events of compound type (e.g., Fig. 4 F–H) are accommodated by combining the foregoing rules.

In each of these events, the new node or nodes that are introduced have node-times equal to the time of the jump.

3.2.1. Emergent lineages and production.

The lineages which descend from an inserted node are said to emerge from the event. Thus, after a birth-type event, the emerging lineages include all the new offspring as well as the parent. Likewise, at pure migration- or sample-type events, each migrating or sampled lineage emerges from the event. At pure death-type events, no lineages emerge. In general, at an event of mark u, there are riu emergent lineages in deme i. We require that riu be a constant, for each u and i. Thus there is a function r:U×D→Z+, such that riu lineages of deme i emerge from each event of mark u. Since, in applications, one is free to expand the set of jump-marks U as needed, this is not a restriction on the models that the theory can accommodate. We say ru≔riui∈D is the production of an event of mark u. Note that the lineages that die as a result of an event do not count in the production but that a parent lineage that survives the event does count.

3.2.2. Conditional independence and exchangeability.

Application of these rules at each jump of Xt constructs a chain of genealogies Gˆk. In particular, at each jump-time Tˆk, the genealogy Gˆk-1 is modified according to the jump-mark Uˆk to yield Gˆk. We view Gˆk as the embedded chain of the continuous-time genealogy process Gt. It is very important to note that, conditional on (Xˆk,Uˆk), the number of parents and number of offspring in each deme is determined and the random choice of which lineages die, migrate, are sampled, or sire offspring is independent of these choices at any other times and independent of (Xˆj,Uˆj) for all j≠k. Moreover, by assumption, the lineages within each deme are exchangeable: any lineage within a deme is as likely as any other lineage in that deme to be selected as a parent or for death, sampling, or migration. Finally, note that Gt does not have the Markov property, though (Xt,Ut,Gt) and Xt,Gt do.

3.3. Pruned and obscured genealogies.

The process just described yields a genealogy that relates all extant members of the population, and all samples. Moreover, it details each lineage’s complete history of movement through the various demes. However, the data we ultimately wish to analyze will be based only on samples. Nor, in general, will the histories of deme occupancy be observable. A generative model must account for this loss of information. We therefore now describe how genealogies are pruned to yield sample-only genealogies and then obscured via the erasure of color from their branches (Fig. 5).

3.3.1. Pruned genealogy.

Given a genealogy G, one obtains the pruned genealogy, P=prune(G) by first dropping every tip node and then recursively dropping every childless internal node (Fig. 5A–B). In a pruned genealogy only internal and sample nodes remain, and sample nodes are found at all of the leaves and possibly some of the interior nodes of the genealogy. Observe that a pruned genealogy is a colored genealogy: it retains information about where among the demes each of its lineages was through time (Fig. 5B). Note also that a pruned genealogy P is characterized by its time, t(P) and the functions PY and PZ just as an unpruned genealogy is. Finally, observe that, since it contains within itself all of its past history, the pruned genealogy process Pt=pruneGt is Markov, even though the unpruned genealogy process, Gt, is not.

3.3.2. Lineage count and saturation.

In the following, we will find that we need to count the deme-specific numbers of lineages present in a given pruned genealogy at a given time. Accordingly, suppose P=(T,Z,Y) is a pruned genealogy and suppose t∈[0,T]. Let ℓi denote the number of lineages in deme i at time t and ℓ≔ℓii∈D∈Z+D. Clearly, ℓ depends only Yt. Therefore, we can define ℓ as a function such that, whenever P=(T,Z,Y) is a pruned genealogy, ℓYt is the vector of deme-specific lineage counts at time t. We refer to ℓ as the lineage-count function (cf. Fig. 6).

We will also have occasion to refer to the deme-specific number of lineages emerging from a given event. In particular, given a node time t in a pruned genealogy P=(T,Y,Z), the number si of lineages of deme i emerging from all nodes with time t is well defined and we can write s≔sii∈D. Like the lineage-count function, s depends only on the local structure of P. However, s depends not only on Yt, but also on Y˜t. Thus, we can define the saturation function such that, whenever P=(T,Y,Z) is a pruned genealogy, sY˜t,Yt is the integer vector of deme-specific numbers of emerging lineages at time t. Fig. 6 illustrates.

3.3.3. Compatibility.

Suppose P is a pruned genealogy, with t(P)=T and t∈ev(P). The local structure of P at t is, in general, compatible with only a subset of the possible jumps U. For example, if the event in P at t is a branch node or a sample node, then it is compatible only with birth-type or sample-type jumps, respectively. Similarly, if the node in P at time t is one at which a lineage moves from deme i to deme i′, then u must be either of i→i′ migration type or of a birth type with parent in i and ri′u>0. To succinctly accommodate all possibilities, let us introduce the indicator function Q such that Q=1 if the local genealogy structure—which is captured by the values of PY just before and after t-is compatible with an event of type u and Q=0 otherwise. That is, Quy,y′=1 if and only if there is a feasible genealogy, G=(T,Z,Y), and history, H, and a t∈[0,T] such that, given GT=G and HT=H, we have Ut=u, Y˜t=y, and Yt=y′. We refer to Q as the compatibility indicator.

3.3.4. Obscured genealogy.

The obscured genealogy is obtained by discarding all information about demes and events not visible from the topology of the tree alone (Fig. 5B–C). In particular, if P=(T,Z,Y) is a pruned genealogy, we write obs(P)=(T,Z) to denote the obscured genealogy.

4. Results.

4.1. Likelihood for pruned genealogies.

Our first result will be an expression for the likelihood of a given pruned genealogy given the history of the population process.

Theorem 1.

Suppose P=(T,Z,Y) is a given pruned genealogy. Define (6) ϕux,y,y′:=n(x)ℓy′rusy,y′Quy,y′,

where n is the deme occupancy (§2.6), ru is the production (§3.2.1), ℓ and s are the lineage-count and saturation functions, respectively (§3.3.2), Q is the compatibility indicator (§3.3.3), and the binomial ratio is as defined in §2.10. Then ProbPT=P∣HT=H=1evH⊇evP∏t∈evH ϕUtXt,Y˜t,Yt.

Proof. If ev(H)⊉ev(P), then H and P are incompatible and ProbPT=P∣HT=H=0. Similarly, if any event of H is incompatible with the local structure of P in the sense of §3.3.3, then ProbPT=P∣HT=H=0. Let us therefore suppose that neither of these conditions hold. Conditional on HT=H, at each time t∈ev(H), a jump of mark Ut occurred, with a production of rUt=rii∈D, resulting in a deme-occupancy of nXt=nii∈D. In P, at time t, there are ℓi=ℓiYt lineages in deme i, of which si=siY˜t,Yt are emergent. By assumption, at each genealogical event, lineages within a deme are exchangeable: each has an identical probability of being involved. This exchangeability implies that each lineage present in a deme at time t was equally likely to have been one of the emergent lineages. In particular, at time t, the probability that si of the ℓi deme-i lineages were among the ri of ni lineages emergent in the unpruned genealogy process is the same as the probability that, upon drawing ℓi balls without replacement from an urn containing ri red balls and ni-ri black balls, exactly si of the drawn balls are red, namely ni-ℓiri-siℓisi(niri).

Because our lineages are labeled, each of the ℓisi equally probable sets of si lineages is distinct; just one of these is the one present in P. Moreover, since, again conditional on HT=H, the identities of the lineages involved in a genealogical event are random and independent of the identities selected at all other events, we have established that ProbPT=P∣HT=H=∏t∈evH nXtℓYtrUtsY~t,Yt.

Returning to the possibility that H is incompatible with P, since ProbPT=P=0 if either any QUt=0 or ev(P)⊈ev(H), we obtain the result.

Next, we show how the likelihood of a pruned genealogies, unconditional on the history, can be computed. For this, we use the filter equation technology developed in Appendix A. In particular, the following theorem follows immediately from Lemma A2.

Theorem 2.

Suppose that P=(T,Z,Y) is a given pruned genealogy. Suppose that w=w(t,x) satisfies the initial condition w(0,x)=p0(x) and the filter equation (7) ∂w∂t(t,x)=∑u∫wt,x′αut,x′,xϕu(x,Y˜t,Yt)dx′−∑u∫w(t,x)αut,x,x′dx′,t∉ev(P),w(t,x)=∑u∫w˜t,x′αut,x′,xϕux,Y˜t,Ytdx′,t∈ev(P),

where ϕ is defined in Eq. 6. Then the likelihood of P is ℒP=∫wT,xdx.

4.2. Likelihood for obscured genealogies.

Our next result concerns the likelihood of a given obscured genealogy conditional on the history.

Theorem 3.

Suppose that (T,Z) is a given obscured genealogy. Let q and π be probability kernels, such that for all x∈X and y∈Y0(Z), q(x,y)⩾0,∑y∈Y0Z q(x,y)=1,

and, for all u∈U,t∈R+,x,x′∈X,y,y′∈Yt(Z), πut,x,x′,y,y′⩾0,∑y′∈YtZ πut,x,x′,y,y′=1.

Suppose moreover that πut,x,x′,y,y′>0 whenever αut,x,x′Quy,y′>0 and that q(x,y)>0 whenever ProbP0Y=y∣X0=x>0. Then there is a stochastic jump process yt with sample paths in Y(Z) such that Xt,Ut,yt is Markov and ProbPTZ=Z∣HT=H=1evH⊇evZE1qX0,y0∏t∈evH  ϕUtXt,y~t,ytπUt(t,X~t,Xt,y~t,yt),

where ϕ is defined in Eq. 6 and the expectation is taken over the sample paths of yt.

Proof. First, observe that, since obs is a deterministic operator, (8) ProbPTZ=Z∣HT=H=E1PTZ=Z∣HT=H.

Our strategy will be to evaluate Eq. 8 using importance sampling: we will propose pruned genealogies compatible with Z as sample paths from a stochastic process driven by Xt and evaluate the the expectation in Eq. 8 by summing over these paths. Conditional on HT=H, the initial distribution q and probability kernel π generate a Markov chain, yˆk such that Probyˆ0∣HT=H=qX0,yˆ0,Probyˆk∣yˆk-1,HT=H=πUˆk(Tˆk,Xˆk-1,Xˆk,yˆk-1,yˆk).

The required process yt is the unique càdlàg process with event times Tˆk and yˆk as its embedded chain. This construction of yt obviously guarantees that ev(H)⊇ev(y)⊇ev(Z) and that Xt,Ut,yt is Markov.

Now, for y∈Y(Z), let us define C(y)=(T,Z,y). Then, by construction, obs (C(y))=(T,Z) and, conversely, for every pruned genealogy P satisfying t(P)=T and PZ=Z, CPY=P. Moreover, the conditions on the kernels q and π guarantee that, if ProbPT=P∣HT=H>0 and PZ=Z, then Proby=PY∣HT=H>0. We therefore have that ProbPTZ=Z∣HT=H=EProbPT=Cy∣HT=HπyH,

the expectation being taken with respect to the random process y. Here, by definition, πyH=qX0,y0∏t∈evH πUtt,X~t,Xt,y~t,yt.

The result then follows from Theorem 1.

Note that, since Yt(Z) is finite, it is permissible, for example, to choose q and π to be uniform.

The final result shows how to compute the likelihood of an obscured genealogy. It is an immediate consequence of Theorem 3 and Lemma A2.

Theorem 4.

Let V=(T,Z) be a given obscured genealogy. Then there are probability kernels q and π as in Theorem 3 such that if βut,x,x′,y,y′=αut,x,x′πut,x,x′,y,y′,Ψut,x,x′,y,y′=ϕux′,y,y′πut,x,x′,y,y′,

and if w=w(t,x,y) satisfies the initial condition w(0,x,y)=p0(x)1{q(x,y)>0} and the filter equation ∂w∂t=∑uy′  ∫wt,x′,y′βu(t,x′,x,y′,y)Ψut,x′,x,y′,ydx′-∑uy′  ∫w(t,x,y)βu(t,x,x′,y,y′)dx′,t∈ev(Z),wt,x,y=∑uy′  ∫w~t,x′,y′βut,x′,x,y′,yΨut,x′,x,y′,ydx′,t∈ev(Z),

then the likelihood of V is ℒV=∑y ∫wT,x,ydx.

Lemma A3 shows how this can be computed via Sequential Monte Carlo.

5. Discussion.

The theory presented here represents a strict generalization of the existing coalescent and birth-death process approaches to phylodynamic inference. In Appendix B, we demonstrate that both of the latter processes are special cases of the genealogical processes constructed here. Importantly, because the theory allows computation of the likelihood via strictly forward-in-time computations, it permits consideration of models for which time-reversal arguments are not available. Moreover, inasmuch as the formulae of Theorem 4 can be efficiently computed via sequential Monte Carlo, explicit expressions for transition probabilities are not needed: it is sufficient to be able to simulate from the population process. This feature of the algorithms—known as the plug-and-play property (He et al., 2010)—further expands the class of population models that can be confronted with data.

In particular, the theory gives us the freedom to choose models with many demes. For deterministic population models, Volz (2012) and Rasmussen et al. (2014) showed how one could accommodate discrete population structure. Their procedures involve solving a large number of differential equations backward in time, relying on the time-reversibility of deterministic dynamics. In general, this time-reversibility is not a property of stochastic processes.

Some existing methods put rather severe limits on the form of the sampling model and, as Volz & Frost (2014) pointed out, misspecification of the sampling model can lead to large inferential biases. With the theory presented here, essentially arbitrary specification of the sampling model is possible. In particular, one can posit sampling at a rate which is an arbitrary function of time and state and include discrete sampling events as well. It is also possible to condition on the existence of samples.

If Sequential Monte Carlo algorithms are used to compute the likelihoods of Theorem 4, then it is straightforward to simultaneously assimilate information from both time-series and genealogical data. One can therefore supplement traditional incidence, disease, or mortality time series with genealogical data in an inferential exercise.

A limitation of the theory is that the population models are assumed to be pure jump processes, which allows consideration of demographic stochasticity and environmental stochasticity modeled by jumps involving multiple individuals (Bretó & Ionides, 2011), but disallows stochastic processes with a diffusive component. It should be possible to incorporate of the full range of Markovian environmental stochasticity via extension of this theory to population models containing both diffusion and jump components.

The price of the theory’s flexibility is primarily computational. When Sequential Monte Carlo is used to evaluate the likelihood in Theorem 4, the computational effort scales linearly with the number of samples. In its most straightforward implementation—using an event-driven algorithm (e.g., Gillespie, 1977)—it scales nonlinearly with population size in general. However, stochastic simulation schemes are available that scale independently of population size (Higham, 2008). On the other hand, the importance sampling underlying Theorem 4 will in general require effort that is exponential in the number of demes. For models with many demes, therefore, approaches for ameliorating or circumventing this curse of dimensionality may be necessary. Critically, the substantial freedom one has in the choice of the importance-sampling distribution π can be exploited for this purpose. In particular, since it is permissible to “borrow information” from the future by means of the importance sampling, there is hope for highly efficient algorithmic computation.

Acknowledgments.

This work was supported by grants from the U.S. National Institutes of Health, (Grant #1R01AI143852 to AAK, #1U54GM111274 to AAK and ELI) and a grant from the Interface program, jointly operated by the U.S. National Science Foundation and the National Institutes of Health (Grant #1761603 to ELI and AAK). QL acknowledges the support of the Michigan Institute for Data Science.

Appendix A. Filter equations.

The likelihoods that appear in Theorems 2 and 4 are integrals over large sets of histories. As such, explicit expressions for them are not available, and we require mathematical tools to allow us to manipulate these quantities and devise algorithms for their numerical solution. The filter equations we introduce here are suitable for these purposes, and we devote this appendix to exposing their essential properties. This extremely convenient formalism has, to our knowledge, not been thoroughly exploited, though we note their resemblance to the constructions of Ogata (1978), Puri & Tuan (1986), Kliemann et al. (1990), and Giesecke & Schwenkler (2018).

Definition.

Let Xt be a continuous-time Markov process with KFE (A1) ∂u∂tt,x=∫ut,x′βt,x′,xdx′-∫ut,xβt,x,x′dx′.

Suppose that B:R+×X2→R+ and λ:R+×X→R are are given measurable functions. Let S⊂R+ be countable and locally finite (i.e., S∩[0,t] is finite for all t>0). Then the system of equations (A2) ∂w∂tt,x=∫wt,x′βt,x′,xBt,x′,xdx′-∫wt,xβt,x,x′dx′-λt,xwt,x,t∉S,

(A3) w(t,x)=∫w~t,x′βt,x′,xBt,x′,xdx′,t∈S,

is called the filter equation generated by β, with boost B, decay λ, and observation times S. The process Xt is said to be the driver of the filter equation. Eq. A2 is the regular part of the filter equation; Eq. A3 is known as the singular part.

Remark.

Trivially, a Kolmogorov forward equation is itself a filter equation with boost 1 , decay 0 , and S=Ø.

The following results show how filter equations allow one to integrate over random histories. First, Lemma A1 shows how one integrates over the full space of histories using a regular filter equation. Lemma A2 builds on this when the set of histories is restricted.

Lemma A1.

Suppose that B:R+×X2→R+ is measurable. Let Vt be an R+-valued random process satisfying EVt∣Ht=Ht=∏e∈evHt Be,X~e,Xe.

Let the family of measures λt on X be defined by λtℰ=EVt⋅1Xt∈ℰ,

for measurable ℰ, and let w(t,x) be the density of λt, i.e., λt(dx)=w(t,x)dx. In particular, Vt=λt(X)=∫w(t,x)dx. Then w satisfies the initial condition w(0,x)=p0(x) and the regular filter equation, (A4) ∂w∂t=∫wt,x′αt,x′,xBt,x′,xdx′-∫wt,xαt,x,x′dx′.

Proof. Since ProbV0=1=1, λ0(ℰ)=ProbX0∈ℰ, which implies that w(0,x)=p0(x). For t>0 and Δ>0 sufficiently small, the expectation can be broken into three terms, according to whether Ht has zero, one, or more than one event in (t-Δ,t]. Accordingly, as Δ↓0, w(t,x)=(1-Δ∫αt-Δ,x,x′dx′)w(t-Δ,x)+Δ∫αt-Δ,x′,xBt-Δ,x′,xwt-Δ,x′dx′+oΔ.

In the limit, we obtain Eq. A4, the regular filter equation generated by α, with boost B and zero decay.

When events are known to have occurred at particular times, it is of interest to integrate over those histories that include an event at each of these times. This leads to singular filter equations, as the next lemma shows. Before we state the lemma, some terminology is needed. Let S be the space of increasing, locally finite sequences in R+, with the topology induced by the Skorokhod metric and Lebesgue measure. For t∈R+ and s∈S, let st≔s∩[0,t]. Thus if s∈S and st=sˆ1,…,sˆK, then the infinitesimal element of Lebesgue measure at st is dst=∏n=1K dsˆn

Lemma A2.

Suppose that B:R+×X2→R+ is measurable and Vt is an R+-valued random process satisfying EVt∣Ht=Ht=∏e∈evHt Be,X~e,Xe.

Let λt be a family measures on X×S defined by λtℰ,𝒮=EVt⋅1Xt∈ℰ⋅1∃s∈𝒮s.t.evHt⊇st,

whenever ℰ⊆X and 𝒮⊆S are measurable. Let w(t,x,s) be the density of this measure, i.e., λtdxds=wt,x,sdxdst.

Then w satisfies (A5) ∂w∂tt,x,s=∫wt,x′,sαt,x′,xBt,x′,xdx′-∫wt,x,sαt,x,x′dx′,t∉s,

(A6) wt,x,s=∫w~t,x′,sαt,x′,xBt,x′,xdx′t∈s.

Proof. The proof proceeds by induction on the cardinality of st. The base case, for which st=Ø, follows immediately from Lemma A1. Assuming that it holds for st<K, one has only to verify Eq. A6. This can be accomplished by integrating Eq. 5 directly.

Remark.

In the same way that Eqs. 3 and 4 can be represented as a single equation by means of a Dirac delta notation, the Eqs. A5 and A6 can be collapsed into a more compact form if β is allowed to have atoms at a countable set of time-points and the boost B is adjusted appropriately.

Filter equations afford a convenient means of computing expectations and likelihoods for pure jump processes. This is facilitated by the following Lemma, the statement of which uses a one-sided Dirac delta function. Specifically, let δv,v′ be the right-sided Dirac delta function satisfying δv,v′=0 for v≠v′ and ∫ab fvδv,v′dv=fv′1v′∈a,b,

whenever f is càdlàg and -∞⩽a<b⩽∞.

Lemma A3.

Eqs. A2 and A3 are satisfied by w(t,x)=∫0∞ vu(t,x,v)dv, where u(t,x,v) satisfies the KFE (A7) ∂u∂t(t,x,v)=∂∂v[λ(t,x)vu(t,x,v)]+∫0∞ ∫ut,x′,v′βt,x′,xδv,Bt,x′,xv′dx′dv′-∫0∞ ∫u(t,x,v)βt,x,x′δv′,Bt,x,x′vdx′dv′,t∉S,u(t,x,v)dx=∫0∞ ∫u˜t,x′,v′πt,x′,dxδv,At,x′Bt,x′,xv′dx′dv′,t∈S.

Here, At,x≔∫βt,x,x′dx′ and t,x,dx′≔βt,x,x′dx′/A(t,x).

Proof. For each t∉S, we have ∂w∂t(t,x)=∫0∞  v∂u∂t(t,x,v)dv=∫0∞  ∬0∞  vut,x′,v′βt,x′,xδv,Bt,x′,xv′dvdx′dv′-∫0∞  ∬0∞  vu(t,x,v)βt,x,x′δv′,Bt,x,x′vdvdx′dv′+∫0∞  v∂∂vλt,xvut,x,vdv.

Here, the non-explosivity assumption guarantees that we can differentiate under the integral sign and exchange the order of integration. Moreover, it ensures that u→0 as v→∞. Hence, by evaluating the first integral with respect to v, the second with respect to v′, and the third by parts, we obtain ∂w∂t(t,x)=∫v′ut,x′,v′βt,x′,xBt,x′,xdv′dx′-∫vu(t,x,v)βt,x,x′dvdx′-λt,x∫vut,x,vdv,

which is simplified to obtain Eq. A2. Similarly, at each t∈S, we have w(t,x)dx=∫0∞  ∬0∞  vu~t,x′,v′πt,x′,dxδv,At,x′Bt,x′,xv′dx′dv′dv=∫0∞  ∫v′u~t,x′,v′πt,x′,dxAt,x′Bt,x′,xdx′dv′=∫w~t,x′βt,x′,xBt,x′,xdx′dx.

which is equivalent to Eq. A3

Remark.

Eqs. A7 are recognizable as the KFE of a certain process Xt,Vt. In particular, the driver Xt has KFE Eq. A1. Vt is directed by Xt in the sense that V has jumps wherever X does: when X jumps at time t from x to x′, V jumps by the multiplicative factor Bt,x,x′⩾0. Between jumps, Vt decays deterministically and exponentially at rate λ(t,x). At the known times in S, X jumps according to the probability kernel π and, V jumps by the factor A(t,x)Bt,x,x′. If we view Vt as a weight, then Lemma A3 tells us how the Vt-weighted average of Xt evolves in time: this average is simply ∫w(t,x)dx. Thus, Lemma A3 shows how to integrate Eqs. A5 and A6 in the Monte Carlo sense.

Appendix B. Examples.

B.1. SIRS model.

King et al. (2022) worked out formulas for the exact likelihood of a genealogy induced by an SIRS model. The theory developed in this paper applies, but since there is only one deme in this model, this is a simple case. Its state vector is x=(S,I,R) and its KFE is ∂v∂t(S,I,R)=βS+1I-1Nv(t,S+1,I-1,R)-βSINv(t,S,I,R)+γ(I+1)v(t,S,I+1,R-1)-γIv(t,S,I,R)+ωR+1vt,S-1,I,R+1-ωRvt,S,I,R.

Here N=S+I+R is the host population size. Note that, though the theory allows for time-dependent event rates, this example is time-homogeneous. This model has one deme and occupancy function n(x)=I. There are four kinds of jumps: transmission, recovery, waning of immunity, and sampling. Accordingly, the marks are U={Trans,Recov,Wane,Sample}. Table B1 gives αu, ru, and the event type for each of these marks.

Given an obscured genealogy Z, let ev (Z)=B∪S0∪S1, where B is the set of branch-times, and S0, S1 are the sets of sample-times with saturations 0 and 1 , respectively. Since there is only one deme, paintings of Z can differ only in number and position of inline, internal nodes along branches. Each of these can only correspond to Table B1. Elements of the SIRS model pertinent to the genealogy process. The table shows the rate αu, jump x↦x′, production ru, and event type for each of the model’s four marks (u).

u	αu	x↦x′	ru	Event type	
	
Trans	βSIN	(S,I)↦(S-1,I+1)	2	pure birth	
Recov	γI	(I,R)↦(I-1,R+1)	0	pure death	
Wane	ωR	(S,R)↦(S+1,R-1)	0	neutral	
Sample	ψI	x↦x	1	pure sample	

u=Trans with s=1. For t∉ev(Z), we can take the importance sampling distribution to be πu=c,u=Trans,s=0,t∉evZ,1-cℓ,u=Trans,s=1,t∉evZ,0,otherwise.

Here c is an arbitrary probability that does not affect the computation. The relevant binomial ratios are nℓrs=(I-ℓ)(I-ℓ-1)I(I-1),u=Trans,s=0,2(I-ℓ)I(I-1),u=Trans,s=1,2I(I-1),u=Trans,s=2,I-ℓI,u=Sample,s=0,1I,u=Sample,s=1.

This leads, for t∉ev(Z), to the following regular part of the filter equation: ∂w∂t=β(S+1)(I-1)N1-(ℓ(t)2)(I2)w(t,S+1,I-1,R)-βSINw(t,S,I,R)+γ(I+1)w(t,S,I+1,R-1)-γIw(t,S,I,R)+ω(R+1)w(t,S-1,I,R+1)-ωRw(t,S,I,R)-ψIwt,S,I,R.

Here, we have summed over the various paintings for u=Trans,s<2. Note the presence of the decay term proportional to ψ. At event-times t∈ev(Z), the singular part of the filter equation reads w(t,S,I,R)=w~(t,S+1,I-1,R)2β(S+1)NI,t∈B,w~(t,S,I,R)ψ(I-ℓ(t)),t∈S0,w~(t,S,I,R)ψ,t∈S1.

Finally, note that w(t,S,I,R)=0 for all I<ℓ(t).

B.2. SEIRS model.

A simple, yet interesting, model with more than one deme is the SEIRS model (Fig. 1A). The state space is R+4, with the state x=(S,E,I,R) defined by the numbers of hosts in each of the four compartments. The KFE for the population process is ∂v∂t(t,S,E,I,R)=βS+1INv(t,S+1,E-1,I,R)-βSINv(t,S,E,I,R)+σE+1vt,S,E+1,I-1,R-σEv(t,S,E,I,R)+γI+1vt,S,E,I+1,R-1-γIv(t,S,E,I,R)+ωR+1vt,S-1,E,I,R+1-ωRvt,S,E,I,R,

Figure B1. Likelihood computation for the SIRS model by Sequential Monte Carlo. (A) A simulated genealogy for β=4, γ=2, ω=1, ψ=1, S0,I0,R0=(97,3,0). (B) A slice through the likelihood surface at the true parameters in the γ-direction. Each point is a distinct Monte Carlo estimate. The blue curve is a LOESS smooth; the dashed lines bound the Monte Carlo-adjusted 95% confidence interval (Ionides et al., 2017).

where N=S+E+I+R is the total population size. Note that the terms associated with sampling cancel each other in the KFE, since, in this model, sampling has no effect on the state.

This model has two demes: D={E,I}. Its deme occupancy function is n(x)=(E,I). There are five kinds of jumps: transmission, progression, recovery, waning of immunity, and sampling. The corresponding marks are U={Trans,Prog,Recov,Wane,Sample}. Table B2 gives αu, ru, and the event type for each of these marks.

Table B2. Elements of the SEIRS model pertinent to the genealogy process. The table shows the rate αu, jump x↦x′), production ru, and event type for each of the model’s five marks (u).

u	αu	x↦x′	ru	Event type	
	
Trans	βSIN	(S,E)↦(S-1,E+1)	(1, 1)	pure birth	
Prog	σE	(E,I)↦(E-1,I+1)	(0, 1)	pure migration	
Recov	γI	(I,R)↦(I-1,R+1)	(0, 0)	pure death	
Wane	ωR	(S,R)↦(S+1,R-1)	(0, 0)	neutral	
Sample	ψI	x↦x	(0, 1)	pure sample	

The filter equation corresponding to the scheme of Table B3 is presented in Box 1. Some numerical results are presented in Fig. B2.

Table B3. Elements of a scheme for numerically computing the likelihood under the SEIRS model. The regular portion of the filter equation holds in between genealogical events (i.e., for t∉B∪S0∪S1); the singular portion describes the effect of these events (t∈B∪S0∪S1). Each line corresponds to a potential event, but only those for which Q=1 appear in the equation. An event with mark u and saturation s has the boost given by the binomial ratio shown (third column). The y↦y′ column depicts the proposed painting schematically, and π is the probability of that proposal. Blue is used for the E deme and yellow for the I deme. For each line, the filter equation contains m terms. An asterisk (*) stands for cases not explicitly mentioned.

	u	s	Q	nℓrs	y↦y′	π	m	Line	
t∉B∪S0∪S1	Trans	(0, 0)	1	E-ℓEEI-ℓII		I+1-ℓII+1	1	1	
(1, 0)	1	I-ℓIEI		12(I+1)	ℓI	2	
(0, 1)	1	E-ℓEEI		12(I+1)	ℓI-	3	
(1, 1)	0				0	4	
Prog	(0, 0)	1	I-ℓII1E⩾ℓE		E+1-ℓEE+11E>ℓE	1	5	
(0, 1)	1	1I1E⩾ℓE		1E+11E>ℓE	ℓE	6	
Recov	(0, 0)	1	1I⩾ℓI		1I>ℓI	1	7	
Wane	(0,0)	1	1		1	1	8	
Sample	*	0				0	9	
t∈B	Trans	(1, 1)	1	1EI		12	1	10	
1	1EI		12	1	11	
0				0	12	
0				0	13	
*	*	0				0	14	
t∈S0	Sample	(0, 0)	1	I-ℓII		1	1	15	
0				0	16	
*	*	0				0	17	
t∈S1	Sample	(0, 1)	1	1I		1	1	18	
0				0	19	
*	*	0				0	20	

Box 1: Filter equation for the SEIRS model

As previously, given an obscured genealogy, let B be the set of its branch times, S0 be the set of tip-sample times, and S1 be the set of inline sample times. Then for t∉B∪S0∪S1, the filter equation reads:

(B8) ∂w∂t(t,S,E,I,R,y)=β(S+1)IN1−ℓEE1−ℓIIw(t,S+1,E−1,I,R,y)+∑k=1ℓIβ(S+1)IN1E1−ℓIIwt,S+1,E−1,I,R,y˜2k+∑k=1ℓIβ(S+1)IN1I1−ℓEEwt,S+1,E−1,I,R,y˜3k−βSINw(t,S,E,I,R,y)+σ(E+1)1E⩾ℓE1−ℓIIw(t,S,E+1,I−1,R,y)+∑k=1ℓEσ(E+1)1E⩾ℓE1Iwt,S,E+1,I−1,R,y˜6k−σEw(t,S,E,I,R,y)+γI+11I⩾ℓIwt,S,E,I+1,R−1,y−γIwt,S,E,I,R,y+ωR+1wt,S−1,E,I,R+1,y−ωRwt,S,E,I,R,y−ψIwt,S,E,I,R,y.

Here, y~jk refers to the coloring of the tree immediately preceding the proposal indicated on line j of Table B3. The integer k specifies the particular branch on which the change occurs.

The singular portion of the filter equation has one component for each distinct type of genealogical event: (B9) w(t,S,E,I,R,y)=β(S+1)IN1EIw~t,S+1,E-1,I,R,y~10+β(S+1)IN1EIw~t,S+1,E-1,I,R,y~11,t∈B,ψI-ℓIw~(t,S,E,I,R,y~15,)t∈S0,ψw~(t,S,E,I,R,y~18),t∈S1.

In addition to Eqs. B8 and B9, the quantity w should satisfy the condition w(t,S,E,I,R,y)=0 whenever E<ℓE or I<ℓI.

A variety of importance-sampling kernels are permissible under the terms of Theorem 4. With a particular choice of importance-sampling kernel, the filter equation uniquely specifies a Sequential Monte Carlo algorithm for estimating the likelihood. The choices made in Table B3 underlie the results displayed in Fig. B2.

B.3. Two-strain competition model.

A simple model for the competition of two strains for susceptible hosts is depicted in Fig. 1B. This example will be included in a forthcoming draft.

B.4. Superspreading model.

Fig. 1D depicts a model of superspreading. This example will be included in a forthcoming draft.

B.5. Linear birth-death model.

In this model, the state variable is the size, Nt, of a population at time t. All individuals face the same per-capita birth and death rates, which are λ and μ, respectively. The KFE is ∂v∂t=λn-1vt,n-1-λnvt,n+μn+1vt,n+1-μnv(t,n)

Stadler (2010) considered the case where samples are taken through time at a uniform per-capita rate ψ. In this case, since there is only one deme, in the filter equation, w can be taken to be independent of y. If B is the set of branch-times and S0, S1 are the sets of terminal and inline samples, respectively, then the regular part of the filter equation is (B10) ∂w∂t(t,n)=λ(n-1)1-(ℓ(t)2)(n2)w(t,n-1)-λnw(t,n)+μn+1wt,n+1-μnwt,n-ψnw(t,n),n⩾ℓ(t),t∉B∪S0∪S1

Figure B2. Likelihood computation for the SEIRS model by Sequential Monte Carlo, using the scheme of Box 1. (A) Simulated genealogy for β=4, σ=1, γ=1, ψ=1, =1, S0,E0,I0,R0=(200,3,5,100). (B) Likelihood slice in the σ-direction. Each point represents the estimate of an independent Sequential Monte Carlo computation. The blue curve shows a LOESS smooth; the dashed vertical lines enclose the Monte Carlo-adjusted 95% confidence interval (Ionides et al., 2017).

and the singular part is (B11) wt,n=λn-1n2w~t,n-1,t∈B,wt,n=ψn1-ℓtnw~t,n,t∈S0,wt,n=ψw~t,n,t∈S1.

Eqs. B10 and B11 are supplemented by the ancillary condition w(t,n)=0 for n<ℓ(t).

B.6. Moran model and the Kingman coalescent.

In the Moran model, events occur according to a rate-μ Poisson process. At each event, a compound birth-death jump (cf. Fig. 4F) occurs so that the population size, n, remains constant. If we let Xt be the number of events that have occurred by time t, then Xt is a simple counting process, which we can use to define the state of the population process. Its KFE is then ∂v∂t=μx-1vt,x-1-μxv(t,x),v(0,x)=1,x=0,0,x>0.

Since there is only a single deme, and since nothing depends on the state, in writing the corresponding filter equation, we can take w to be independent of both x and y.

In the classical case (Kingman, 1982a), m samples are taken simultaneously at a single time, T. Then, if B is the set of branch-times and ℓ(t) is the number of lineages in the genealogy at time t, the filter equation reads (B12) w0=1,∂w∂t=μwt1-ℓt2n2-μwt,t∉B,wt=μn2w~t,t∈B.

Figure B3. Likelihood computation for the constant-parameter, linear birth-death-sampling model, according to Theorem 4 via Sequential Monte Carlo. Panel (A) shows the genealogy, simulated for λ=1.2, μ=0.8, ψ=1, N0=5. Panel (B) shows a likelihood slice, through the true parameters in the μ direction. As computational effort (i.e., number of particles) increases, the Monte Carlo estimates converge on the exact values, for which an explicit formula exists in this case. The dashed horizontal lines show the approximate maximized likelihood and the 95% critical value (under the likelihood-ratio test). Panels (C-E) are log-log plots that show how the root-mean-square error (RMSE), imprecision (SD), and bias decrease with effort. Note that the bias and the SD are roughly inversely proportional to the effort and its square-root, respectively, as expected.

Integrating Eqs. B12 and taking logarithms yields (B13) logwT=klogμn2−μn2∑i=m−kmi2si,

where k=|B| is the number of branch-points in [0,T] and the si≔∫1{ℓ(t)=i}dt are the durations of the coalescent intervals, i.e., intervals between successive branch-points. We recognize Eq. B13 as the expression for the Kingman (1982a) coalescent (e.g., Wakeley, 2009).

More generally, if in addition samples are taken according to a rate- ν Poisson process such that the set of sample-times in the genealogy is S=S0∪S1, where S0, S1 are the sets of times of terminal and inline samples, respectively, then the filter equation reads (B14) w0=1,∂w∂t=-μℓt2n2wt,t∉S∪B,wt=μn2w~t,t∈B,

wt=ν1-ℓtnw~t,t∈S0,wt=νnw~t,t∈S1.

Integrating Eqs. B14 yields (B15) logw(T)−|S|logν=∑t∈S0log1−ℓ(t)n−S1logn+|B|logμn2−μn2∑i=1∞i2si.

Figure 1. Examples of discretely-structured population models. Demes are shaded. Compartments containing infectious hosts are outlined in green. Curved green lines connect transmission rates with the compartments whose occupancies control their modulation; each such connection gives rise to a nonlinearity in the model. (A) An SEIRS model. Susceptible individuals (S), once infected, enter a transient incubation phase (E) before they become infectious (I). Upon recovery (R), individuals experience immunity from reinfection. If this immunity wanes, they re-enter the susceptible compartment. Pathogen lineages are to be found in hosts within the E and I compartments only. Accordingly, there are two demes: D={E,I}. If there is exactly one lineage per host, then the occupancy, nXt=nEXt,nIXt, is the integer 2-vector giving the numbers of hosts in the respective compartments. See §2.6 for definition and discussion of demes and deme occupancy. (B) In this four-deme model, two distinct pathogen strains compete for susceptibles. (C) A three-deme model according to which, after an incubation period, hosts may develop asymptomatic infection IA. If they do not recover, symptomatically infected hosts (IS) can progress to hospitalization (H) and death (D). (D) A three-deme model with heterogeneity in transmission behavior. Contagious individuals move randomly between low-transmission IL and high-transmission IH behaviors.

Figure 2. Markov state transition diagram for the SEIRS model depicted in Fig. 1A. The state, x, is characterized by four numbers, S, E, I, and R. From a given state x, there are five possible kinds of jumps x↦x′. Accordingly, the set, U, of jump marks has five elements. Each of these is of a different type: Trans (transmission) is of birth type, Prog (progression) is of migration type, Recov (recovery) is of death type, Sample (sampling) is of sample type, and Wane (loss or waning of immunity) is of neutral type. See §3.1 for a description of these jump types. Note that, in this formulation, when a sampling event occurs, the state does not change.

Figure 3. A genealogy, G, specifies the relationships of shared ancestry (via its tree-structure) and deme occupancy histories (via the coloring of its branches) of a set of lineages extant at some time t(G), as well as some samples gathered at earlier times. Here, t(G)=10 and there are two demes, D={blue,yellow}. Tip nodes, denoting extant lineages, are shown as black dots; sample nodes are shown as blue dots; internal nodes are indicated in green. Note that internal nodes occur not only at branch-points, but also inline (i.e., along branches). Wherever a lineage moves from one deme (color) to another, an internal node occurs; the converse does not necessarily hold.

Figure 4. Event types differ by their effects on the genealogy. This can be seen by examining the local structure of the genealogy in the neighborhood of a jump. (A) A birth-type jump results in the branching of one or more child lineages from the parent. There can be only one parent, though the demes of the child lineages may differ from that of their parent. Here, a parent of the blue deme sires one child lineage in each of the blue and yellow demes. The production of an event is an integer vector, with one entry for each deme. The production of this event is therefore r=rblue,ryellow=(2,1). The deme occupancy of an event is the number of lineages in each deme just to the right of the event. The deme occupancy at this event is therefore n=nblue,nyellow=(3,5). (B) A death-type event causes the extinction of a lineage. Since internal nodes without children are recursively removed, the affected branch is dropped. The production of this event is r=(0,0) and the deme occupancy is n=(3,4). (C) A migration-type event results in the movement of one or more lineages from one deme to another. Here, one lineage moves from the yellow to the blue deme. The production of this event is r=(1,0), i.e., the production is 1 for the blue deme and 0 for the yellow. The deme occupancy is n=(6,2). (D) In a sample-type event, one or more sample nodes (blue circles) are inserted. Here, there are two samples, one in each of the blue and yellow demes. Accordingly, r=(1,1) and n=(2,6). (E) A neutral-type event has no effect on the genealogy and zero production in all demes: =(0,0), n=(5,3). (F) The theory presented here allows for compound events. As an example, here a birth/death-type event occurs, wherein one yellow lineage is extinguished and a blue lineage simultaneously sires a blue child. For this event, we have r=(2,0) and n=(6,2). (G) Here, a compound sample/death-type event with r=(0,0) and n=(2,5) occurs. A blue lineage is sampled and simultaneously extinguished. Note that recursive removal does not occur, since sample nodes are never removed. (H) A compound birth/migration-type event with r=(4,0) and n=(6,2).

Figure 5. Unpruned, pruned, and obscured genealogies from a single realization of the genealogy process induced by the SEIRS model depicted in Figs. 1 and 2. (A) A realization of the unpruned genealogy process Gt is shown at t=10. Tip nodes, corresponding to lineages alive at time t=10 are indicated with black points. Blue points represent samples; green points, internal nodes. Branches are colored according to the deme in which the corresponding lineage resided at that point in time: blue denotes E and yellow, I. (B) The genealogy is pruned by deleting all tip nodes and then recursively pruning away childless internal nodes. Sample nodes are never removed. (C) A pruned genealogy is obscured by effacing all deme information from lineage histories: the colors are erased, as are all inline nodes. See the text (§§2.9,3.3.1, and 3.3.4) for more detail.

Figure 6. Lineage count and saturation.

Each panel shows the neighborhood of a single event in the unpruned genealogy (top row) and the corresponding pruned genealogy (bottom row). Pruning consists of the removal of all branches that are not ancestral to some sample. In the bottom row of panels, pruned branches are indicated using broken lines. (A) A birth-type event with production r=rblue,ryellow=(1,1) occurs. (B) Suppose that pruning results in the removal of the dashed lineages. Then the lineage count at this event-time is ℓ=ℓblue,ℓyellow=(2,2). The saturation is s=(0,1) since only a single, yellow lineage emerges from the event. (C) A migration-type event with production r=(0,1) occurs. (D) After pruning, ℓ=(2,2) and s=(0,1). (E) A sample-type event occurs in which two blue lineages are sampled (production r=(2,0)). (F) After pruning, ℓ=(2,2) and s=(1,0). Observe that in panels B and D, the local structures of the pruned genealogies are identical, though they arise from events of different type.
==== Refs
References.

Alizon S. (2024) Phylodynamics. In Didier G. & Guindon S. (eds.), Models and Methods for Biological Evolution, pp. 259–282. Hoboken, New Jersey: Wiley. 10.1002/9781394284252.ch11
Bretó C. & Ionides E. L. (2011) Compound Markov counting processes and their applications to modeling infinitesimally over-dispersed systems. Stochastic Processes and their Applications 121 :2571–2591. 10.1016/j.spa.2011.07.005
Drummond A. J. , Rambaut A. , Shapiro B. , & Pybus O. G. (2005) Bayesian coalescent inference of past population dynamics from molecular sequences. Molecular Biology and Evolution 22 :1185–1192. 10.1093/molbev/msi103 15703244
Felsenstein J. (2004) Inferring Phylogenies. Sunderland, Mass.: Sinauer.
Giesecke K. & Schwenkler G. (2018) Filtered likelihood for point processes. Journal of Econometrics 204 :33–53.10.1016/j.jeconom.2017.11.011
Gillespie D. T. (1977) Exact stochastic simulation of coupled chemical reactions. Journal of Physical Chemistry 81 :2340–2361. 10.1021/j100540a008
Grenfell B. T. , Pybus O. G. , Gog J. R. , Wood J. L. N. , Daly J. M. , Mumford J. A. , & Holmes E. C. (2004) Unifying the epidemiological and evolutionary dynamics of pathogens. Science 303 :327–332. 10.1126/science.1090727 14726583
Griffiths R. C. & Tavaré S. (1994) Sampling theory for neutral alleles in a varying environment. Philosophical Transactions of the Royal Society of London, Series B 344 :403–410. 10.1098/rstb.1994.0079 7800710
He D. , Ionides E. L. , & King A. A. (2010) Plug-and-play inference for disease dynamics: measles in large and small populations as a case study. Journal of the Royal Society, Interface 7 :271–283. 10.1098/rsif.2009.0151 19535416
Higham D. J. (2008) Modeling and simulating chemical reactions. SIAM Review 50 :347–368. 10.1137/060666457
Ionides E. L. , Breto C. , Park J. , Smith R. A. , & King A. A. (2017) Monte carlo profile confidence intervals for dynamic systems. Journal of the Royal Society, Interface 14 :20170126. 10.1098/rsif.2017.0126 28679663
King A. A. , Lin Q. , & Ionides E. L. (2022) Markov genealogy processes. Theoretical Population Biology 143 :77–91. 10.1016/j.tpb.2021.11.003 34896438
Kingman J. F. C. (1982a) The coalescent. Stochastic Processes and their Applications 13 :235–248. 10.1016/0304-4149(82)90011-4
Kingman J. F. C. (1982b) On the genealogy of large populations. Journal of Applied Probability 19 :27–43. 10.2307/3213548
Kliemann W. H. , Koch G. , & Marchetti F. (1990) On the unnormalized solution of the filtering problem with counting process observations. IEEE Transactions on Information Theory 36 :1415–1425. 10.1109/18.59936
Leventhal G. E. , Günthard H. F. , Bonhoeffer S. , & Stadler T. (2014) Using an epidemiological model for phylogenetic inference reveals density dependence in HIV transmission. Molecular Biology and Evolution 31 :6–17. 10.1093/molbev/mst172 24085839
MacPherson A. , Louca S. , McLaughlin A. , Joy J. B. , & Pennell M. W. (2021) Unifying phylogenetic birth-death models in epidemiology and macroevolution. Systematic Biology 71 :172–189. 10.1093/sysbio/syab049 34165577
Möhle M. (2000) Ancestral processes in population genetics—the coalescent. Journal of Theoretical Biology 204 :629–638. 10.1006/jtbi.2000.2032 10833361
Möller S. , du Plessis L. , & Stadler T. (2018) Impact of the tree prior on estimating clock rates during epidemic outbreaks. Proceedings of the National Academy of Sciences 115 :4200–4205. 10.1073/pnas.1713314115
Moran P. A. P. (1958) Random processes in genetics. Mathematical Proceedings of the Cambridge Philosophical Society 54 :60–71. 10.1017/s0305004100033193
Ogata Y. (1978) The asymptotic behaviour of maximum likelihood estimators for stationary point processes. Annals of the Institute of Statistical Mathematics 30 :243–261. 10.1007/bf02480216
Puri M. L. & Tuan P. D. (1986) Maximum likelihood estimation for stationary point processes. Proceedings of the National Academy of Sciences 83 :541–545. 10.1073/pnas.83.3.541
Rasmussen D. A. , Ratmann O. , & Koelle K. (2011) Inference for nonlinear epidemiological models using genealogies and time series. PLoS Computational Biology 7 :e1002136. 10.1371/journal.pcbi.1002136 21901082
Rasmussen D. A. , Volz E. M. , & Koelle K. (2014) Phylodynamic inference for structured epidemiological models. PLoS Computational Biology 10 :e1003570. 10.1371/journal.pcbi.1003570 24743590
Stadler T. (2010) Sampling-through-time in birth-death trees. Journal of Theoretical Biology 267 :396–404. 10.1016/j.jtbi.2010.09.010 20851708
Volz E. M. (2012) Complex population dynamics and the coalescent under neutrality. Genetics 190 :187–201. 10.1534/genetics.111.134627 22042576
Volz E. M. & Frost S. D. W. (2014) Sampling through time and phylodynamic inference with coalescent and birth-death models. Journal of the Royal Society, Interface 11 :20140945. 10.1098/rsif.2014.0945 25401173
Volz E. M. , Kosakovsky Pond S. L. , Ward M. J. , Leigh Brown A. J. , & Frost S. D. W. (2009) Phylodynamics of infectious disease epidemics. Genetics 183 :1421–1430. 10.1534/genetics.109.106021 19797047
Volz E. M. & Siveroni I. (2018) Bayesian phylodynamic inference with complex models. PLoS Computational Biology 14 :e1006546. 10.1371/journal.pcbi.1006546 30422979
Wakeley J. (2009) Coalescent Theory: An Introduction. New York: W. H. Freeman.
