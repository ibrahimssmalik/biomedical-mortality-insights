
==== Front
Sensors (Basel)
Sensors (Basel)
sensors
Sensors (Basel, Switzerland)
1424-8220
MDPI

10.3390/s24113478
sensors-24-03478
Article
A Compensation Method for the Geomagnetic Measurement Error of an Underwater Ship-Borne Magnetometer Based on Constrained Total Least Squares
Tong Yude Formal analysis Writing – original draft 1
Huang Xiaoying Methodology Formal analysis Writing – original draft Writing – review & editing 2*
Chen Yongbing Conceptualization Methodology 1
Li Wenkui Data curation 1
Zha Feng Funding acquisition 1
Xing Bowen Academic Editor
Zhao Yunhe Academic Editor
Xu Jingxiang Academic Editor
1 College of Electrical Engineering, Naval University of Engineering, Wuhan 430033, China; tongyude@126.com (Y.T.); hgcyb@163.com (Y.C.); lwk404@tom.com (W.L.); zha_feng@126.com (F.Z.)
2 Department of Operational Research and Programing, Naval University of Engineering, Wuhan 430033, China
* Correspondence: hjgchxy@163.com; Tel.: +86-138-7116-7016
28 5 2024
6 2024
24 11 347809 4 2024
15 5 2024
24 5 2024
© 2024 by the authors.
2024
https://creativecommons.org/licenses/by/4.0/ Licensee MDPI, Basel, Switzerland. This article is an open access article distributed under the terms and conditions of the Creative Commons Attribution (CC BY) license (https://creativecommons.org/licenses/by/4.0/).
When magnetic matching aided navigation is applied to an underwater vehicle, the magnetometer must be installed inside the vehicle, considering the navigation safety and concealment of the underwater vehicle. Then, the interference magnetic field will seriously affect the accuracy of geomagnetic field measurement, which directly affects the accuracy of geomagnetic matching aided navigation. Therefore, improving the accuracy of geomagnetic measurements inside the vehicle through error compensation has become one of the most difficult problems that requires an urgent solution in geomagnetic matching aided navigation. In order to solve this problem, this paper establishes the calculation model of the internal magnetic field of the underwater vehicle and the geomagnetic measurement error model of the ship-borne magnetometer. Then, a compensation method for the geomagnetic measurement error of the ship-borne magnetometer, based on the constrained total least square method, is proposed. To verify the effectiveness of the method proposed in this paper, a simulation experiment of geomagnetic measurement and compensation of a ship-borne three-axis magnetometer was constructed. Among them, to be closer to the real situation, a combination of the geomagnetism model, the elliptic shell model and the magnetic dipole model was used to simulate the internal magnetic field of the underwater vehicle. The experimental results indicated that the root mean square error of geomagnetic measurement in an underwater vehicle was less than 5 nT after compensation, and the accuracy of geomagnetic measurement met the requirements of geomagnetic matching aided navigation.

constrained total least squares
geomagnetic measurement
compensation method
ship-borne magnetometer
National Natural Science Foundation of China42176195 42074010 42174051 This research was funded by the National Natural Science Foundation of China (grant numbers: 42176195, 42074010 and 42174051).
==== Body
pmc1. Introduction

With the ongoing development of the world’s economy and military capabilities, underwater tasks are becoming more and more diversified, and the demand for navigation, positioning accuracy and reliability of underwater vehicles (including submarines, unmanned underwater vehicles, self-propelled mines, mines, etc.) is growing day by day. At present, underwater navigation and positioning mainly adopts the inertial navigation system (INS). However, using only pure INS, the positioning error accumulates and diverges with time, making it difficult to ensure that underwater navigation and positioning maintains high precision for a long time. Considering this limitation, INS is usually corrected in real time or periodically by matching aided navigation based on a certain geophysical field. The common methods include terrain matching aided navigation [1], gravity matching aided navigation [2,3] and geomagnetic matching aided navigation [4,5]. The traditional matching algorithms include TERCOM, ICCP, SITAN, matching algorithms based on the Kalman filter and other intelligent matching algorithms. Geomagnetic matching aided navigation has the characteristics of passivity, no radiation, strong concealment and no accumulation of errors over time, and can be used for all-weather and all-regional navigation, which makes it an important research direction for underwater aided navigation in geophysical fields. Using a magnetometer to quickly and accurately measure geomagnetic data is the key element to realizing geomagnetic matching aided navigation. When applying local magnetic matching aided navigation to underwater vehicles, the magnetometer must be installed inside the vehicle, taking into account the navigation safety and concealment of the underwater vehicle [6]. At this time, the total magnetic field obtained by a ship-borne magnetometer is the superposition of the geomagnetic field, carrier magnetic field and random magnetic field. Therefore, the interference magnetic field in underwater carrier geomagnetic measurement mainly comes from the carrier magnetic field (solid magnetic field, induced magnetic field), the random magnetic field and the instrument error of the magnetometer itself, with the carrier magnetic field accounting for a relatively large proportion [7,8,9]. Interference magnetic fields will seriously affect the accuracy of geomagnetic field measurements, thereby affecting the accuracy of geomagnetic matching navigation [10,11,12,13]. Therefore, improving the accuracy of geomagnetic surveys through error compensation has become one of the most urgent and difficult problems to solve in geomagnetic matching navigation.

A lot of research has been conducted on the error compensation method of magnetometers inside vehicles. When the attitude of the vehicle is not considered, the magnetometer error mainly comes from the non-orthogonal error, the scale factor error and the zero offset error of the three-axis sensor. Roberto Alonso and others used the TWO-STEP algorithm to estimate the scale factor and non-orthogonal correction, which has demonstrated good performance [14]. Demoz Gebre Egziabher used the TWO-STEP algorithm and least square estimation to correct the experimental data of a three-axis magnetometer, and the results showed that the residual after correction was very small [15]. Zhang Dewen and others put forward a two-step correction method for the component error of a three-axis magnetic sensor to correct the total magnetic field and the components of the three-axis magnetic sensor [16]. Wang Lihui and others combined the total least square method with the regularization method to propose a truncated total least square method to deal with the ill-conditioned problem of random errors on both sides of the observation equation [17]. The simulation results showed that the method effectively suppressed the ill-conditioned influence in magnetometer measurements. Zhang Qi and others put forward a calibration method for a three-axis magnetic field sensor based on the linearization parameter model and deduced the linearization parameter model between the three-axis measured value of the sensor and the scalar value of the magnetic field [18]. Experimental research shows that this method is a convenient and accurate sensor calibration method. S. Bonnet and others put forward a unified algorithm framework for calculating calibration parameters, such as sensor non-orthogonal error and magnetometer installation error, which was proven to be very effective [19].

When the magnetometer is installed inside the vehicle, the observation error caused by the carrier attitude (hard magnetic error) and the interference field error around the magnetometer (soft magnetic error) should also be considered. Pang Hongfeng systematically studied the error mechanism of a ship-borne geomagnetic vector system, three-axis magnetic sensor correction, misalignment error correction between inertial navigation and a magnetic sensor coordinate system and inertial navigation interference component compensation. The vector system after compensation was tested and applied to regional magnetic anomaly measurement, which verified the advantages of the geomagnetic vector system in magnetic anomaly measurement [20]. Wu Zhitian put forward an integrated method of magnetometer calibration and geomagnetic field compensation. Then, the measurement error of a ship-borne three-axis magnetometer was analyzed, and a parameterized model, including magnetometer calibration error and geomagnetic field measurement error, was established [21]. Finally, the total least squares (TLS) algorithm was used to estimate the parameters of the model, and the experimental results showed that a better compensation effect could be achieved. Zhang Ying and others used truncated total least squares (TTLS) technology to solve the ill-conditioned magnetometer calibration problem, and studied the effectiveness of this method through vehicle experiments. Their results showed that this method can effectively alleviate the ill-conditioned influence in magnetometer calibration and obtain a more stable numerical solution [22]. Because the linearization of the magnetometer observation equation introduces noise to both the system matrix A and data vector B simultaneously, the standard least square solution is not optimal.

Apart from the least squares method, there are other methods that can be used to solve the compensation problem of geomagnetic measurement in underwater vehicles, such as the Kalman filter algorithm, the neural network method, the genetic algorithm and the particle swarm optimization algorithm. In view of the current situation of frequent attitude change during flight, compared with the previous single modeling method, Huan S. and others introduced the eddy current magnetic field for integrated modeling and used the EKF algorithm for compensation [23]. The simulation results showed that this method not only reduces the error amplitude significantly, but also effectively filters out the fluctuation caused by the eddy current magnetic field in the attitude compensation of the aircraft. Yang B. and others adopted a joint estimation iterative algorithm to calibrate the three-axis magnetometer, comparing its performance with that of the EKF algorithm and the nonlinear least squares algorithm [24]. The experimental results showed that the joint estimation iterative algorithm reduced the mean average of the three-axis magnetometer’s measured error from 69.5211 nT to 9.241 nT. Cheng Z studied the calibration method of the magnetometer based on BP neural network, which reduced the influence of model error on calibration accuracy [25]. The numerical simulation results showed that this method can reduce the measurement error of the magnetometer to less than 10 nT. Yu P. and others proposed a neural network compensation method based on regression equations and generalized regression neural networks, which can improve the generalization of the compensation model and weaken the effect of over-fitting [26]. ZHU Xingle and others adopted the Adaptive Multi-Population Genetic Algorithm (AMGA) to calculate a ship’s induced and permanent magnetic parameters [27]. The simulation results indicated that this method has fast computing speed and good stability, with the maximum error of three-component geomagnetic field measurement after compensation being less than 10 nT. Li Ting and others proposed a new magnetic field measurement error compensation method based on the damped particle swarm optimization (DPSO) algorithm. The experimental results showed that this algorithm has good suppression capability to compensate for magnetic field measurement error [28].

Based on previous research experience, this paper proposes a new method to compensate for geomagnetic measurement errors in underwater vehicles based on constrained total least squares. In order to eliminate the magnetic interference of underwater vehicles and improve the geomagnetic measurement accuracy inside underwater vehicles, we established a calculation model of the internal magnetic field of underwater vehicles and the geomagnetic measurement error model of a ship-borne magnetometer. Then, we propose a compensation method for the geomagnetic measurement error of a ship-borne magnetometer based on the constrained total least square method. To verify the effectiveness of the method proposed in this paper, a simulation experiment of geomagnetic measurement and compensation of a ship-borne three-axis magnetometer was constructed. Among them, in order to be closer to the real situation, a combination model of the geomagnetism model based on the IGRF (International Geomagnetic Reference Field) model, the induced magnetic field model simulated by the rotating elliptic shell model and the fixed magnetic field model simulated by the magnetic dipole model was used to simulate the internal magnetic field of the underwater vehicle. In the simulation experiment, firstly, a track in the maneuvering area was designed to obtain the data needed to identify the compensation model parameters P and O. Then, another track in the matching area was designed to verify the geomagnetic measurement compensation accuracy of the compensation model with P and O. The experimental results show that the root mean square error of geomagnetic measurement in the underwater vehicle after compensation is less than 5 nT, and the accuracy of geomagnetic measurement meets the needs of geomagnetic matching aided navigation.

2. Modeling of the Underwater Vehicle’s Internal Magnetic Field

Previous studies on the magnetic field of underwater vehicles have mostly focused on estimating the magnetic field outside the underwater vehicle’s hull by establishing ellipsoid, magnetic dipole or mixed models [29,30,31]. Qu Xiaohui and others analyzed the application scope of various magnetic field models [32]. For example, with few sensors, the uniform rotating ellipsoid model is generally used to achieve rapid positioning of the magnetic target. If there are enough sensors near the field source, a mixed model of ellipsoid and magnetic dipole models can be used to improve positioning accuracy. If the sensor is far away from the magnetic target, a single magnetic dipole model can be used. In order to simulate the underwater vehicle’s internal magnetic field more accurately, a combination model was adopted in this paper. This model included the geomagnetism model based on the IGRF (International Geomagnetic Reference Field) model, the induced magnetic field model simulated by the rotating elliptic shell model and the fixed magnetic field model simulated by the magnetic dipole model.

2.1. Global Geomagnetic Field Calculation

As an internationally accepted global geomagnetic standard model, the IGRF model describes the Earth’s main magnetic field and its long-term variation. In December 2019, the International Association of Geomagnetism and Aviation (IAGA) released the 13th generation International Geomagnetism Reference Field (IGRF13), which uses the Gaussian spherical harmonic analysis model, based on the reference sphere and the spherical center coordinate system, to represent any point of the global geomagnetic field on the ground or above. According to [33], the scalar potential function V(r,θ,ϕ,t) of the main magnetic field can be expressed as a spherical harmonic series in the IGRF model, as follows:(1) V(r,θ,ϕ,t)=a∑n=1N∑m=0narn+1gnmtcosmϕ+hnmtsinmϕPnmcosθ

where r, θ and ϕ represent the coordinates in the geocentric spherical coordinate system. r represents the radial distance from any point in space to the center of the geomagnetic reference sphere, measured in km and θ, ϕ represent the geocentric latitude and longitude, respectively. a is the radius of the reference sphere, which is close to the average radius of the earth. Usually, we use a=6371.2km. Pnmcosθ is an associative Legendre function with N-order and M-order Schmidt quasi-normalization. gnmt and hnmt are Gaussian spherical harmonic coefficients with time variation, which can be calculated using IGRF13.

In the passive region of near-Earth space, the main magnetic field caused by the field source inside Earth can be expressed as the negative gradient of the scalar potential function B=−∇V. In the spherical coordinate system, the relationship between components Xe, Ye and Ze (horizontal component Xe in the North, horizontal component Ye in the East, vertical component Ze) and the magnetic potential V is as follows:(2) Xe=1r∂V∂θ, Ye=−1rsinθ∂V∂ϕ, Ze=∂V∂r

The geomagnetic components Xe, Ye and Ze can be calculated using the following Equation:(3) Xe=∑n=1N∑m=0nRrn+2gnmtcosmϕ+hnmtsinmϕddθPnmcosθYe=∑n=1N∑m=0nRrn+2msinθgnmtsinmϕ−hnmtcosmϕPnmcosθZe=−∑n=1N∑m=0nRrn+2n+1gnmtcosmϕ+hnmtsinmϕPnmcosθ

When the cutoff order N and the Gaussian spherical harmonic coefficient are determined, the three components of the main magnetic field can be calculated using Equation (3).

2.2. Calculation of the Internal Magnetic Field of the Rotating Ellipsoidal Shell Model

To analyze the magnetization of the iron rotating ellipsoid shell in a uniform external magnetic field, we should consider the additional magnetic field and the demagnetization coefficient generated by the uniformly magnetized rotating ellipsoid before calculating its internal magnetic field and the magnetic induction intensity.

As shown in Figure 1, the long and short semi-axes of the rotating ellipsoid shell’s outer surface and inner surface are ae, be and ai, bi, respectively, and their half focal length is g.

According to [34], when the external magnetization field source is uniform, the magnetic field in the cavity of the ellipsoidal shell after magnetization is a uniform field, which is consistent with the direction of the magnetization field source. The shielding coefficients (the ratio of the magnetic field in the cavity after magnetization to the external magnetic field) for magnetization along the longitudinal axis and transverse axis directions are as follows:(4) Ll=11+χmμrμrNelR−Nil−KNel1+χmNel

(5) Ls=11+χmμrμrNesR−Nis−KNes1+χmNes

where, L1 and Ls are the shielding coefficients when magnetized along the longitudinal axis and the transverse axis, respectively. μr is the relative permeability of the ferromagnetic shell. χm=μr−1 is the permeability of the ferromagnetic shell. Nel and Nes are the demagnetization coefficients in the direction of the long and short axes of the solid ellipsoid, respectively, with long and short semi-axes ae, be. Nil and Nis are the demagnetization coefficients in the direction of the long and short axes of the solid ellipsoid, respectively, with long and short semi-axes ai, bi.

The parameters K and R can be calculated as follows: K=aibi2aebe2, R=1−K.

In the ellipsoidal coordinate system, the external magnetic field components in the long axis direction, short axis direction and vertical direction are denoted as Bel, Bes and Bez, respectively. According to the shielding coefficient, the magnetic induction intensity components in the rotating ellipsoid shell can be calculated using Equation (6), as follows:(6) Bx=Ll×Bel,By=Ls×Bes,Bz=Ls×Bez

2.3. Magnetic Dipole Field Calculation

The main components of an underwater ships’ magnetic field are generated not only from the iron pressure-resistant shell magnetized by the geomagnetic field, but also from the internal electrical equipment (such as the propulsion motor, the inertial navigation system, etc.). This part of the magnetic field has a certain relationship with the vehicle’s working state. When the working state of the carrier is stable, the magnetic field caused by the vehicle’s electrical equipment can be regarded as a fixed value [35]. When the interference source is at a certain distance from the magnetic sensor, it can be approximated as a single magnetic dipole. To simplify the problem, a magnetic dipole was used to simulate the total magnetic field generated by all of the internal electrical equipment, based on the superposition principle of magnetic fields. As shown in Figure 2, a right-hand space rectangular coordinate system was established with the center of the magnetic dipole as the origin, where the circular current intensity is I and the radius is R.

The magnetic moment is defined as follows:(7) P→m=I⋅S⋅n→

where S is the area of the plane surrounded by the circular current; that is, S=πR2. n→ is the normal vector of the plane of the circular current, whose direction conforms to the right-hand rule with respect to I. The Z-axis is in the direction of the magnetic moment vector positively. M is a point in space with spherical coordinates Mr,φ0,θ0, where r is the distance from the coordinate system origin to M, φ0 is the zenith angle and θ0 is the rotation angle of the meridian plane, where M is located relative to the meridian plane of the X-axis. The conversion relationship between the rectangular coordinates and the spherical coordinates is as follows:(8) x=rsinφ0cosθ0y=rsinφ0sinθ0z=rcosφ0

where 0≤r<+∞, 0≤φ0<π, 0≤θ0<2π.

Let the magnetic dipole in the space have magnetic permeability μ, intercepting a current element Idl at any point PR,π/2,θ on the circumference. According to Biot–Savart law, the magnetic induction intensity vector generated by this current element at M is as follows:(9) dB→=μ4πIdl→×a→a3a≠0

where dl→ is the circumferential tangent vector at P and a→ is the vector PM. Then, (10) dl→×a→=i→j→k→−RsinθdθRcosθdθ0rsinφ0cosθ0−Rcosθrsinφ0sinθ0−Rsinθrcosφ0

Let the magnetic induction intensity be B→=Bxi→+Byj→+Bzk→. By substituting Equation (10) into Equation (9), we obtain the following:(11) Bx=μIR·rcosφ04π∫02πcosθa3dθBy=μIR⋅rcosφ04π∫02πsinθa3dθBz=μIR4π∫02πR−rsinφ0cosθ−θ0a3dθ

Integrating and substituting Equation (11) yields the following:(12) Bx=3μ8πPmR2+r23r2sin2φ0cosθ0R2+r2By=3μ8πPmR2+r23r2sin2φ0sinθ0R2+r2Bz=μ2πPmR2+r231−3r2sin2φ02R2+r2

When the magnetic moment of the dipole is known, the magnetic induction intensity vector at any point in space can be obtained using Equation (12).

3. Error Model and Compensation Algorithm of the Ship-Borne Magnetometer

3.1. Error Model

The measurement error of the ship-borne magnetometer mainly includes the magnetometer’s instrument error and the underwater vehicle’s interference field error. Instrument error mainly includes three-component non-orthogonal error, scale factor error and zero offset error. Interference field error mainly includes hard magnetic error, soft magnetic error and random error. The error model is as follows:(13) BSIb=CSIBeb+BHIb

where Beb is the geomagnetic field vector in the volume coordinate system. BHIb is the hard magnetic error vector. BSIb is the soft magnetic error vector. CSI is the soft magnetic coefficient matrix.

In the body coordinate system, the measurement output of the ship-borne magnetometer can be modeled as follows:(14) Bs=CNOCSFBeb+BHIb+BSIb+bobCNO=100sinρcosρ0sinφcosλsinλcosφcosλ,CSF=a000b000c

where Bs represents the measurement output vector of the ship-borne magnetometer. ρ, φ and λ are the total non-orthogonal error angles and CNO represents the non-orthogonal error matrix. a, b and c are the total scale factor errors and CSF represents the scale factor error matrix. bob represents the sensor zero bias error vector.

Substituting Equation (13) into Equation (14) yields the following:(15) Bs=CNOCSFBeb+BHIb+CSIBeb+BHIb+bob    =CNOCSF(I3×3+CSI)(Beb+BHIb)+bob

Simplifying Equation (15) yields the following:(16) Bs=KBeb+O

where K=CNOCSFI3×3+CSI and O=KBHIb+bob.The parameter matrices K and O can be calculated as follows [36]:(17) K=1Bea00bsinρbcosρ0csinφcosλcsinλccosφcosλ,O=o1o2o3

where o1∼o3 are the total zero bias errors. Be is the true value of the geomagnetic field.

The total non-orthogonal error angle comes from the manufacturing process error of the magnetometer, the installation error of the magnetometer and the soft magnetic error. The total scale factor error comes from the sensor scale factor error and the soft magnetic error. The total bias error consists of sensor bias error and hard magnetic error. The parameter matrix K is a lower triangular matrix. This is to reduce the model parameters. It is assumed that the X-axis of the sensor coordinate system is completely coincident with the X-axis of the body coordinate system to ensure the uniqueness of K. The nine parameters in Equation (17) describe the input and output process of the three-axis magnetometer completely [37]. It should be noted that the position accuracy of the magnetic field sensor inside the underwater vehicle does indeed have an impact on geomagnetic measurements. Specifically, different installation positions of the sensor can lead to bias errors in geomagnetic measurements. However, this bias error is already included in the O matrix of error model and will eventually be eliminated by the error compensation calculation, so there is no need to consider the accuracy of the sensor’s position. However, in the actual measurement process, to avoid introducing significant interference errors, we still tried to keep the sensors away from the magnetic interference sources as much as possible.

The error compensation model of the three-axis magnetometer can be obtained by the inverse calculation of Equation (16), as follows:(18) B^eb=K−1Bs−O=PBs−O

where B^eb is the projection of the compensated geomagnetic field measured value in the body coordinate system, and the matrix P=K−1 is also a lower triangular matrix. The compensation process of the magnetometer is equivalent to identifying the nine parameters in Equation (17).

3.2. Compensation Algorithm Based on Constrained Total Least Squares

It is assumed that the output of the compensated magnetometer Bs is equal to the local geomagnetic reference field Beb. Then, the following equation holds:(19) R=B^b2=P(Bs−O)2

According to the principle of modal testing, the compensation value is obtained by minimizing the square of difference between the magnetometer’s output and the mode value of the geomagnetic field to realize the error compensation of the geomagnetic field value, as follows:(20) argminf(P,O)=R−P(Bs−O)22

For convenience, we squared both sides of Equation (34) to obtain the following equation:(21) R2=B^b22=P(Bs−O)22

The objective function becomes:(22) argminf(P,O)=R2−P(Bs−O)222                                                             =R−P(Bs−O)22R+P(Bs−O)22

Substituting Bs=[Bxs,Bys,Bzs]T and Equation (17) into Equation (22) and expanding, then simplifying it, yields the following model:(23) a1(Bxs)2+a2BxsBys+a3BxsBzs+a4Bys2+a5BysBzs+a6Bzs2+a7Bxs+a8Bys+a9Bzs+a10=0

where ai,i=1,2,⋯10 are intermediate variables defined by error compensation parameters P and O. The transformation formula from ai,i=1,2,⋯10 to the parameters of a, b, c and ρ, φ, λ in P, O is as follows:(24) X=−1a6a1,a2,a3,a4,a5,a7,a8,a9,a10T=A,B,C,D,E,G,H,I,JTα1=−B2+DC2+4DA+AE2−BECα2=4AE2J−E2G2−4BECJ+2ECHG+2BEIG−4EHAI−4DICG−C2H2    +4DAI2+2CBHI−4DG2+4DC2J+4BHG−4AH2−B2I2−4B2J+16DAJα3=E4A−CBE3+E2C2D−2B2E2+8DAE2−4DB2+16D2Aβ1=2BH+BEI−2CDI−4DG+ECH−E2Gβ2=−2AEI+4AH−BCI−2BG+C2H−CEGβ3=4DIA−2DGC+EGB−IB−2EHA+CBHa=12α1−α2(4D+E2)b=12α1−α2(4A+C2)c=12α1α2(4DA−B2)                      tanρ=−12α1(2B+EC)tanφ=1α1(BE−2CD)tanλ=E−α1/α3

Assuming that the number of geomagnetic field measurements is q, the observation equation composed of these measurements can be combined into a linear equation in matrix form as follows:(25) AX=b

where   A=Bx1s2Bx1sBy1sBx1sBz1sBy1s2By1sBz1sBx1sBy1sBz1s1Bx2s2Bx2sBy2sBx2sBz2sBy2s2By2sBz2sBx2sBy2sBz2s1⋯⋯      ⋯Bxqs2BxqsByqsBxqsBzqsByqs2ByqsBzqsBxqsByqsBzqs1X=−1a6a1a2a3a4a5a7a8a9a10       Tb=Bz1s2Bz2s2⋯Bzqs2T                                                    

Because q is much larger than the unknown parameters in the observation equation, Equation (25) is an over-determined linear equation set. By solving the unknown parameter vector X^, the estimated P^ and O^ of the compensation parameters can be calculated by substituting Equation (24) into Equation (17).

If the system matrix A is accurate and the data vector b is disturbed by noise, the solution of Equation (25) can be estimated using the standard least square method [38]:(26) XLS=ATA−1ATb

However, for the error compensation problem of the magnetometer, the linearization of the observation equation causes both A and b to be disturbed by noise at the same time, resulting in the standard least square solution not being optimal.

We expand the matrices A and b by Taylor series, and their first-order approximate perturbation is:(27) A¯=A+ΔAb¯=b+Δb

where A¯ and b¯ represent the error-free system matrix and the data vector, respectively. ΔA and Δb are the corresponding perturbation terms, which are related. Then, it is appropriate to solve this problem using the constrained total least squares (CTLS) method [39]. Since Golub and others put forward the concept of TLS [40], this method has been widely used in signal processing, statistics, computers and so on. Based on the mathematical model, we discuss the TLS of Singular Value De-composition (SVD)[41]. CTLS is an extension algorithm of TLS, which reduces the problem to an unconstrained minimization problem on a small variable set. In this paper, the constrained total least squares method, based on the SVD solution, was adopted.

Firstly, the random noise vector is defined as follows:(28) v=B˜x1sB˜y1sB˜z1sB˜x2sB˜y2sB˜z2s⋯B˜xqsB˜yqsB˜zqsT

According to Equation (28), v∈ℜ3q×1 and v∼ℕ0,σ2I3q, we can transform ΔA and Δb into the following form using random noise vectors, as follows:(29) ΔA=F1vF2v⋯F9v, Δb=F10v

The expressions of Fi∈ℜq×3q, i=1,2,…,10 and Fi can be found in [42].

Substituting A¯ and b¯ into the over-determined Equation (25) to ensure compatibility, we obtained the following:(30) A+ΔAX=b+Δb

Substituting Equation (29) into Equation (30) and arranging it yielded the following Equation:(31) AX−b=−ΔAX+Δb                                               =−F1vF2v⋯F9vX+F10v                             =−∑i=19xiFi−F10v  =−Hxv

where xi is the i-th element of the vector X, Hx=∑i=19xiFi−F10. Thus, the problem of magnetometer error compensation can be transformed into a mathematical problem solved by CTLS, as follows:(32) minX,vvF2  s.t.  Ax−b+HXv=0

where ∗F2 is a Frobenius norm. According to Equation (32), the random noise vector v is estimated as follows:(33) v^=−Hx†AX−b

where Hx†=HxTHx−1HxT is the generalized inverse of Hx. The following equation can be obtained by substituting v^ into Equation (32):(34) argminFX=vTv=AX−bTHxHxT−1AX−bwithrespecttoX

The solution of CTLS can be obtained by minimizing Equation (34) with the Newton iteration method, whose iteration equation is as follows:(35) Xr+1=Xr−Hr−1Tr

where r is the number of iterations. Tr and Hr represent the gradient vector and Hessian matrix of the r−th iteration, respectively. The specific expressions of Tr and Hr are shown in [31]. The convergence criterion of the algorithm is to calculate whether the F norm of Tr is less than the threshold εstop; that is, TrF<εstop.

The error compensation steps of the three-axis magnetometer based on the CTLS method are as follows:

Step 1: use the SVD solution as the initial value of the Newton iteration method;

Step 2: calculate Xr+1 according to Equation (35);

Step 3: repeat Step 2 until the following convergence condition is met: TrF<εstop;

Step 4: calculate the nine correction parameters ρ,φ,λ,a,b,c,o1,o2,o3 according to the solution X^r+1 of CTLS, and then obtain the estimated compensation matrices P^=K−1 and O^;

Step 5: calculate the compensated geomagnetic measurement value according to Equation (18) with P^=K−1 and O^.

4. Experiment

4.1. Output Simulation of the Magnetometer

The simulation area was set to be in the range of 120°~120.1° East longitude and 25.5°~25.6° North latitude, as shown in Figure 3. The regional geomagnetic field was calculated using the IGRF model. In the maneuvering area and the matching area, two tracks of the vehicle were designed to be in the shape of “∞” and a “double circle”, respectively, as shown in Figure 4. The combination of the geomagnetism model, the elliptic shell model and the magnetic dipole model with Gaussian white noise were adopted to simulate the internal magnetic field of the vehicle.

The model parameters of the rotation ellipsoid shell included the major axis (a=51.5 m), the minor axis (b=5.25 m), the thickness of the shell (0.035 m) and the relative permeability (μr=50).

The parameter of the magnetic dipole model was the magnetic moment Pm=314.6 A/m2, and its direction was consistent with the long axis direction of the ellipsoid shell.

Gaussian white noise: μ0=0.0.

The simulation results are shown in Figure 3 and Figure 5. The variation of the geomagnetic field within the vehicle’s track was about 40 nT, whereas the variation of the additional magnetic field generated by the magnetization of the vehicle’s iron ellipsoid shell was more than 10000 nT without the influence of the magnetic dipole interference field and random noise. Therefore, it is impossible to obtain the real geomagnetic field value without error compensation.

4.2. Compensation Simulation of the Magnetometer’s Measurement

In order to test the robustness of the algorithm in this paper, we added Gaussian white noise to the simulation data in the maneuvering area and set the signal-to-noise ratio (SNR) to 80, 90 and 95. When the vehicle was in the maneuvering area, we obtained the simulation data Be and Bs. On this basis, the mediate variables ai,i=1,2,⋯10 were identified using the CTLS solution from Equation (25). Then, according to Equation (24), the parameters of a, b, c and ρ, φ, λ were calculated using the mediate variables. Finally, we obtained the compensation parameter matrices P and O, according to Equation (17). The calculation results and the RMSEs are shown in Figure 6 and Table 1. It can be seen that the RMSE decreases as SNR increases, with a maximum value of less than 3.1 nT. The calculated compensation parameter matrices P and O were used to correct the magnetic field in the matching area.

With the compensation parameter matrices P and O, we calculated the compensated geomagnetic field valve in the matching area (the SNR was also set to 80, 90 and 95). The compensation results are shown in Figure 7.

From the above compensation results, with an increase in SNR from 80 to 90, the compensation error decreased and the RMSE decreased from 2.82 to 0.95. Moreover, we can see that the compensation residual reflects the signal noise level and the uneven field in the region. Therefore, to reduce the compensation error, we should make the vehicle’s moving area as small as possible in the compensation area and try to keep the course unchanged and stable. This will prevent estimation errors caused by the uneven magnetic field in the region.

5. Conclusions

The measurement error of a three-axis magnetometer can be described by nine parameters. After establishing the error compensation model, the model can be linearized with the help of intermediate parameters, and then compensation parameters can be quickly obtained using the linear optimization method.

The simulation experiment results show that when the magnetometer is installed inside the underwater vehicle, the observation equation is seriously ill-conditioned due to the influence of iron shell’s demagnetization field and noise. Both the data matrices and parameter matrices contain significant errors, necessitating the use of an improved constrained total least squares method to solve them.

Although the linear solution speed is fast, when the observation data is noisy and the error compensation model is severely ill-conditioned, the CTLS method based on SVD decomposition is biased. Then, the gradient Tr in the Gaussian–Newton method increases sharply, and the decrease during iteration is not significant, and may lead to non-converge. It is necessary to improve relevant algorithms to achieve higher compensation accuracy in linear solving.

Acknowledgments

The partial data in this paper were obtained from the National Oceanic and Atmospheric Administration (NOAA), which are public data. MATLAB and Mathematica were used for image presentation and data analysis. We express our sincere gratitude to these organizations and software providers.

Author Contributions

Y.T. was the project leader and was responsible for defining the scientific requirements that met the research goals. The authors’ individual contributions are summarized as follows: conceptualization, X.H. and Y.C.; data curation, W.L.; formal analysis, Y.T. and X.H.; funding acquisition, X.H. and F.Z.; methodology, Y.C.; writing—original draft, Y.T. and X.H.; writing—review and editing, X.H. All authors have read and agreed to the published version of the manuscript.

Data Availability Statement

The original contributions presented in this study are included in this article. Further inquiries can be directed to the corresponding author.

Conflicts of Interest

The authors declare that this research was conducted in the absence of any commercial or financial relationships that could be construed as a potential conflict of interest.

Figure 1 Rotating ellipsoid shell.

Figure 2 Magnetic dipole in a space rectangular coordinate system.

Figure 3 Geomagnetic field data on track points.

Figure 4 Regional geomagnetic field and the vehicle’s track.

Figure 5 Magnetic field data at track points using the magnetometer’s measurements.

Figure 6 Compensation results in the maneuvering area.

Figure 7 Compensation results in the matching area.

sensors-24-03478-t001_Table 1 Table 1 Magnetometer compensation parameters and the RMSE of compensation error in the maneuvering area.

SNR	P	O	RMSE	
80	1.0594000.0009461.68800.0004140.000157 1.6875	102.1721.972.84	3.02	
90	1.0598000.0011941.688400.0005800.0003061.6876	117.5828.194.31	1.86	
95	1.0599000.0012811.688500.0006600.0003801.6877	123.6530.615.06	1.73	

Disclaimer/Publisher’s Note: The statements, opinions and data contained in all publications are solely those of the individual author(s) and contributor(s) and not of MDPI and/or the editor(s). MDPI and/or the editor(s) disclaim responsibility for any injury to people or property resulting from any ideas, methods, instructions or products referred to in the content.
==== Refs
References

1. Zhang J. Xu Z. Wang X. Research on error of underwater terrain aided navigation based on TERCOM algorithm J. Nav. Univ. Eng. 2020 32 44 49
2. Zou J. Cai T. Improved Particle Swarm Optimization screening iterative algorithm in gravity matching navigation IEEE Sens. J. 2022 22 20866 20876 10.1109/JSEN.2022.3208114
3. Gao S. Cai T. Fang K. Gravity-matching algorithm based on K-Nearest neighbor Sensors 2022 22 4454 10.3390/s22124454 35746235
4. Zhai H. Wang L. The robust residual-based adaptive estimation Kalman filter method for strap-down inertial and geomagnetic tightly integrated navigation system Rev. Sci. Instruments 2020 91 104501 10.1063/5.0019305 33138561
5. Ji C. Chen Q. Song C. Improved particle swarm optimization geomagnetic matching algorithm based on simulated annealing IEEE Access 2020 8 226064 226073 10.1109/ACCESS.2020.3043794
6. Li J. Study on the Characteristics and Compensation Method of Vehicle Interferential Magnetic Field in Geomagnetic Measurement Ph.D. Thesis National University of Defense Technology Changsha, China 2013
7. Henkel P. Calibration of Magnetometers with GNSS Receivers and Magnetometer-Aided GNSS Ambiguity Fixing J. Sens. 2017 17 1324 10.3390/s17061324
8. Henkel P. Berthold P. Kiam J.J. Calibration of Magnetic Field Sensors with Two Mass-Market GNSS Receivers Proceedings of the IEEE Workshop on Positioning, Navigation and Communication (WPNC) Dresden, Germany 12–13 March 2014 5
9. Crassidis J. Lai K.-L. Harman R. Real-time attitude-independent three-axis magnetometer calibration J. Guid. Control Dyn. 2005 28 115 120 10.2514/1.6278
10. Alimi R. Fisher E. Nahir K. In Situ Underwater Localization of Magnetic Sensors Using Natural Computing Algorithms J. Sens. 2023 23 1797 10.3390/s23041797
11. Su X. Ullah I. Liu X. Choi D. A Review of Underwater Localization Techniques, Algorithms, and Challenges J. Sens. 2020 2020 6403161 10.1155/2020/6403161
12. Wang H. Wang S. Bu R. Zhang E. A Novel Cross-Layer Routing Protocol Based on Network Coding for Underwater Sensor Networks Sensors 2017 17 1821 10.3390/s17081821 28786915
13. Callmer J. Skoglund M. Gustafsson F. Silent Localization of Underwater Sensors Using Magnetometers EURASIP J. Adv. Signal Process. 2010 2010 709318 10.1155/2010/709318
14. Alonso R. Shuster M.D. Complete Linear Attitude-Independent Magnetometer Calibration J. Astronaut. Sci. 2003 50 477 490 10.1007/BF03546249
15. Gebre-Egziabher D. Elkaim G.H. Powell J.D. Parkinson B.W. Calibration of Strapdown Magnetometers in Magnetic Field Domain J. Aerosp. Eng. 2006 19 87 102 10.1061/(ASCE)0893-1321(2006)19:2(87)
16. Zhang D. Zhang Q. Tian W. Component Calibration of Three-Axis Magnetometer with Two Step method Chin. J. Sens. Actuators 2018 31 1707 1713
17. Wang L. Yu L. Liang B. Qiao N. Truncated total least squares algorithm in restraining random error of geomagnetic navigation magnetometer J. Chin. Inert. Technol. 2015 23 763 768
18. Zhang Q. Pan M. Chen D. Pang H. Scalar Calibration of Tri-Axial Magnetometer with Linearized Parameter Model Chin. J. Sens. Actuators 2012 25 215 219
19. Bonnet S. Bassompierre C. Godin C. Lesecq S. Barraud A. Calibration methods for inertial and magnetic sensors Sens. Actuators A Phys. 2009 156 302 311 10.1016/j.sna.2009.10.008
20. Pang H.F. Luo S.T. Chen D.X. Pan M.C. Zhang Q. Error Calibration of Fluxgate Magnetometers in Arbitrary Attitude Situation J. Test Meas. Technol. 2011 25 371 375
21. Wu Z. Wu Y. Hu X. Wu M. Calibration of Strapdown Three-axis Magnetometer and Measurement Error Compensation of Geomagnetic Field Based on Total Least Squares Acta Armamentarii 2012 33 1202 1209
22. Zhang Y. Yang R. Li M. Zuo J. Chen X. Calibration of Vehicular Three-axis Magnetometer via Truncated Total Least Squares Algorithm Acta Armamentarii 2015 36 427 432
23. Sun H. Yang B. Wu H. Li C. Wang R. Integrated Compensation Method of Three-axis Magnetometer Based on EKF Algorithm J. Proj. Rocket. Missiles Guid. 2019 39 149 154
24. Yang B. Wang R. Sun H. Integrated Error Compensation Method for Three-Axis Magnetometer in Geomagnetic Navigation. In Lecture Notes in Electrical Engineering Proceedings of the China Satellite Navigation Conference (CSNC) 2020 Proceedings: Volume I. CSNC 2020 Chengdu, China 22–25 November 2020 Springer Singapore 2020 Volume 650 650 10.1007/978-981-15-3707-3_59
25. Cheng Z. Calibration Method of Magnetometer Based on BP Neural Network J. Comput. Commun. 2020 6 31 41
26. Yu P. Zhao X. Jia J. Zhou S. An improved neural network method for aeromagnetic compensation Meas. Sci. Technol. 2021 32 045106 10.1088/1361-6501/abd1b4
27. Zhu X.L. Chen S.H. Method on eliminating magnetic interference in shipboard geomagnetic field measurement Ship Sci. Technol. 2019 41 126 129
28. Li T. Zhang J.S. Wang S.C. Li D.Y. Compensation of geomagnetic field measurement error based on damped particle swarm optimization Chin. J. Sci. Instrum. 2017 38 2246 2452
29. Zhang W. Zhang G. New Measuring and Calculate Method of Submarine Space Magnetic Field Ship Electron. Eng. 2010 4 170 173
30. Zhang Y. Mao S. Modeling Analysis and Application of Submarine Space Magnetic Ship Electron. Eng. 2018 38 136 139
31. Lin C. Single-row Ellipsoid and Magnetic Dipole Mixed Model in Ship Magnetic Field Depth Conversion Mine Warf. Ship Prot. 1996 3 54 58
32. Qu X. Yang R. Shan Z. Analysis and comparison on magnetic field modeling method of submarine Ship Sci. Technol. 2011 33 7 11
33. Alken P. Thebault E. Beggan C.D. Amit H. Aubert J. Baerenzung J. Bondar T.N. Brown W.J. Califf S. Chambodut A. International Geomagnetic Reference Field: The thirteenth generation Earth Planets Space 2021 73 49 10.1186/s40623-020-01288-x
34. Zhou Y. Zhang G. Ship Magnetic Field Analysis and Calculation National Defence Industry Press Beijing, China 2004
35. Yang L. Liu T. Warship Magnetic Field Simulation Technology Based on Magnetic Dipoles Ship Electron. Eng. 2017 37 60 64
36. Foster C.C. Elkaim G.H. Extension of a Two-Step Calibration Methodology to Include Nonorthogonal Sensor Axes IEEE Trans. Aerosp. Electron. Syst. 2008 44 1070 1078 10.1109/TAES.2008.4655364
37. Vasconcelos J.F. Elkaim G. Silvestre C. Oliveira P. Cardeira B. Geometric Approach to Strapdown Magnetometer Calibration in Sensor Frame IEEE Trans. Aerosp. Electron. Syst. 2011 47 1293 1306 10.1109/TAES.2011.5751259
38. Bjorck A. Least squares methods Handb. Numer. Anal. 1990 1 465 652
39. Abatzoglou T. Mendel J. Harada G. The constrained total least squares technique and its applications to harmonic superresolution IEEE Trans. Signal Process. 1991 39 1070 1087 10.1109/78.80955
40. Golub G.H. Loan C.V. An Analysis of the Total Least Squares Problem Cornell University Ithaca, NY, USA 1980
41. Huffel S.V. Vandewalle J. The Total Least Squares Problem: Computational Aspects and Analysis Society for Industrial and Applied Mathematics University City, PA, USA 1991
42. Wu Z. Research on Geomagnetic Measurement Error Compensation for Underwater Geomagnetic Navigation Ph.D. Thesis National University of Defense Technology Changsha, China 2013
